
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>FinancePro - Controle Financeiro para Eventos</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #6a11cb;
    --primary-light: #8e2de2;
    --accent: #ff4e50;
    --success: #1db954;
    --danger: #ff416c;
    --warning: #ff9a00;
    --dark: #2c3e50;
    --light: #f8f9fa;
    --light-gray-bg: #f7f8fa;
    --gray: #95a5a6;
    --gray-light: #e9ecef;
    --text-color: #34495e;
    --card-bg: #ffffff;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
    --event-purple: #9b59b6;
    --event-blue: #3498db;
    --event-red: #e74c3c;
    --event-orange: #e67e22;
    --event-green: #2ecc71;
  }
  :root {
      --event-purple: #9b59b6;
      --event-blue: #3498db;
      --event-red: #e74c3c;
      --event-orange: #e67e22;
      --event-green: #2ecc71;
      --event-teal: #1abc9c;
    }

    .feature-item:nth-child(6n+1)::after { background: var(--event-purple); }
    .feature-item:nth-child(6n+2)::after { background: var(--event-blue); }
    .feature-item:nth-child(6n+3)::after { background: var(--event-red); }
    .feature-item:nth-child(6n+4)::after { background: var(--event-orange); }
    .feature-item:nth-child(6n+5)::after { background: var(--event-green); }
    .feature-item:nth-child(6n+6)::after { background: var(--event-teal); }

    .feature-item:nth-child(6n+1) i { color: var(--event-purple); background-color: rgba(155, 89, 182, 0.1); }
    .feature-item:nth-child(6n+2) i { color: var(--event-blue); background-color: rgba(52, 152, 219, 0.1); }
    .feature-item:nth-child(6n+3) i { color: var(--event-red); background-color: rgba(231, 76, 60, 0.1); }
    .feature-item:nth-child(6n+4) i { color: var(--event-orange); background-color: rgba(230, 126, 34, 0.1); }
    .feature-item:nth-child(6n+5) i { color: var(--event-green); background-color: rgba(46, 204, 113, 0.1); }
    .feature-item:nth-child(6n+6) i { color: var(--event-teal); background-color: rgba(26, 188, 156, 0.1); }
  

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--light-gray-bg);
    color: var(--text-color);
    font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif;
    line-height: 1.6;
    padding-bottom: 60px; /* Espaço para o rodapé fixo */
  }

  .app-container { display: flex; flex-direction: column; min-height: 100vh; }

  /* ================================== */
  /* NAVEGAÇÃO (TOP E BOTTOM) */
  /* ================================== */
  .top-bar {
    background: linear-gradient(to right, var(--primary), var(--primary-light));
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .top-bar .page-title { font-size: 1.2rem; font-weight: 600; color: white; }
  .top-bar .icon-button { background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer; }
  
  .bottom-nav {
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: white;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 0;
    box-shadow: 0 -2px 15px rgba(0,0,0,0.06);
    z-index: 100;
    height: 60px;
  }
  .bottom-nav-item {
    background: none; border: none; cursor: pointer; display: flex;
    flex-direction: column; align-items: center;
    gap: 4px; color: var(--gray);
    font-size: 0.75rem; font-weight: 500; padding: 5px 15px; border-radius: 12px; transition: var(--transition);
    height: 100%;
    justify-content: center;
  }
  .bottom-nav-item i { font-size: 1.4rem; }
  .bottom-nav-item.active { color: var(--primary); }
  .bottom-nav-item:hover { background-color: var(--light-gray-bg); }

  /* ================================== */
  /* CONTEÚDO PRINCIPAL E LAYOUT */
  /* ================================== */
  .main-content {
    flex: 1;
    padding: 80px 20px 90px;
    display: flex; flex-direction: column; gap: 25px;
    transition: var(--transition); overflow-y: auto;
  }
  .page-header { display: flex;
    justify-content: space-between; align-items: center; margin-bottom: 0; }
  .page-header h1 { font-size: 1.8rem; font-weight: 700; color: var(--dark); }
  .section-title { 
    font-size: 1.1rem; 
    font-weight: 600; 
    color: var(--dark); 
    margin: 20px 0 15px 0;
    position: relative;
    padding-left: 15px;
  }
  .section-title::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(to bottom, var(--primary), var(--primary-light));
    border-radius: 4px;
  }
  .tab-content { display: none;
    animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .tab-content.active { display: flex; flex-direction: column; gap: 20px; }
  
  /* ================================== */
  /* DASHBOARD E COMPONENTES */
  /* ================================== */
  .feature-grid { display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
  .feature-item {
    background-color: var(--card-bg); border-radius: 12px; padding: 20px;
    display: flex; flex-direction: column; align-items: flex-start; gap: 10px;
    font-size: 1rem; font-weight: 500; color: var(--dark); box-shadow: var(--shadow);
    transition: var(--transition); cursor: pointer;
    border: 1px solid var(--gray-light);
    position: relative;
    overflow: hidden;
  }
  .feature-item::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(to right, var(--primary), var(--primary-light));
  }
  .feature-item:hover { transform: translateY(-5px);
    box-shadow: var(--shadow-hover); border-color: var(--primary); }
  .feature-item i {
    font-size: 1.5rem; color: var(--primary);
    background-color: rgba(106, 17, 203, 0.1);
    width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
  }

  .notifications-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .notifications-banner {
    display: none; color: white; padding: 15px 20px; border-radius: 12px;
    align-items: center; gap: 15px;
    font-weight: 500; cursor: pointer;
    border-left: 5px solid rgba(255,255,255,0.3);
  }
  .notifications-banner.warning { background-color: var(--warning); }
  .notifications-banner.info { background-color: var(--event-blue); }
  .notifications-banner i { font-size: 1.5rem; }

  .shortcuts-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;
    -ms-overflow-style: none; scrollbar-width: none; }
  .shortcuts-container::-webkit-scrollbar { display: none; }
  .shortcut-item {
    background-color: var(--card-bg);
    border-radius: 12px; padding: 15px;
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    min-width: 120px; text-align: center; box-shadow: var(--shadow);
    border: 1px solid var(--gray-light); cursor: pointer; transition: var(--transition);
    position: relative;
    overflow: hidden;
  }
  .shortcut-item::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(to right, var(--primary), var(--primary-light));
  }
  .shortcut-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
  .shortcut-item i { font-size: 1.3rem;
    color: var(--primary); }
  .shortcut-item span { font-size: 0.9rem; font-weight: 500; color: var(--text-color); }
  
  .main-cta-button { 
    width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 600; margin-top: 15px;
    background: linear-gradient(to right, var(--primary), var(--primary-light));
    border: none;
    color: white;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition);
  }
  .main-cta-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
  }
  
  .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
  .summary-card {
    background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow);
    padding: 20px; display: flex; flex-direction: column;
    gap: 5px; cursor: pointer;
    transition: var(--transition); position: relative; overflow: hidden; border: 1px solid var(--gray-light);
  }
  .summary-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
  }
  .summary-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
  .summary-card h3 { font-size: 0.9rem; color: #6c757d; margin: 0;
    font-weight: 500; }
  .summary-card .value { font-size: 1.6rem; font-weight: 700; }
  .summary-card .trend, .summary-card .forecast { font-size: 0.8rem;
    color: var(--gray); margin-top: 4px; }
  .summary-card .trend.up { color: var(--success); }
  .summary-card .trend.down { color: var(--danger); }
  .receita .value { color: var(--success); }
  .despesa .value { color: var(--danger); }
  .saldo .value { color: var(--primary); }
  .balanco .value { color: var(--event-purple); }
  .receita::after { background: var(--success); }
  .despesa::after { background: var(--danger); }
  .saldo::after { background: var(--primary); }
  .balanco::after { background: var(--event-purple); }

  /* ================================== */
  /* ELEMENTOS GERAIS (Cards, Modals, etc.) */
  /* ================================== */
  .card {
    background: var(--card-bg);
    border-radius: 16px; box-shadow: var(--shadow);
    padding: 24px; margin-bottom: 0; transition: var(--transition); border: 1px solid var(--gray-light);
    position: relative;
    overflow: hidden;
  }
  .card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(to right, var(--primary), var(--primary-light));
  }
  .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
  .card h2 {
    font-size: 1.5rem; margin-bottom: 20px; color: var(--dark); font-weight: 600;
    display: flex; align-items: center;
    gap: 10px;
  }
  .card h2 i { color: var(--primary); }

  /* Tabelas e Transações */
  .table-wrapper { overflow-x: auto; }
  table { width: 100%; border-collapse: separate;
    border-spacing: 0; margin: 0; }
  th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-light); vertical-align: middle; }
  th { background: var(--light-gray-bg); color: var(--dark); font-weight: 600; }
  td .btn { margin: 2px; }
  .positive { color: var(--success); font-weight: 600; }
  .negative { color: var(--danger); font-weight: 600; }
  .transactions-list-container { display: flex; flex-direction: column; gap: 16px; }
  .transaction-card {
      background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow);
      padding: 20px; transition: var(--transition);
      border-left: 5px solid var(--gray);
      position: relative;
  }
  .transaction-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 4px;
    background: var(--gray);
    border-radius: 4px 0 0 4px;
  }
  .transaction-card:hover { transform: translateY(-4px);
    box-shadow: var(--shadow-hover); }
  .transaction-card.receita { border-left-color: var(--success); }
  .transaction-card.receita::before { background: var(--success); }
  .transaction-card.despesa { border-left-color: var(--danger); }
  .transaction-card.despesa::before { background: var(--danger); }
  .transaction-card.orcamento { border-left-color: var(--event-orange); }
  .transaction-card.orcamento::before { background: var(--event-orange); }

  .transaction-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .transaction-body { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
  .transaction-favorecido { font-size: 1.2rem; font-weight: 600;
    color: var(--dark); }
  .transaction-details { font-size: 0.9rem; color: var(--gray); }
  .transaction-footer { 
    display: flex;
    justify-content: space-between; align-items: center; 
    border-top: 1px solid var(--gray-light); padding-top: 16px; margin-top: 16px;
  }
  .transaction-value { font-size: 1.4rem; font-weight: 700; }
  .category-badge {
    display: inline-block; padding: 4px 12px; border-radius: 20px;
    background: rgba(106, 17, 203, 0.1);
    font-size: 0.85rem; color: var(--primary); font-weight: 500;
  }
  .status-badge {
    display: inline-block; padding: 4px 10px; border-radius: 12px;
    font-size: 0.8rem; font-weight: 500;
  }
  .status-badge.confirmada, .status-badge.pago, .status-badge.realizado { background: rgba(29, 185, 84, 0.15); color: var(--success); }
  .status-badge.pendente, .status-badge.emitido, .status-badge.agendado, .status-badge.emitido-orcamento { background: rgba(255, 154, 0, 0.15); color: var(--warning); }
  .status-badge.cancelado { background: rgba(255, 65, 108, 0.15); color: var(--danger); }
  .status-badge.confirmado { background: rgba(106, 17, 203, 0.15);
    color: var(--primary); }
  .status-badge.aprovado-orcamento { background: rgba(46, 204, 113, 0.15); color: var(--event-green); }

  
  /* Modal de Detalhes do Balanço */
  .balance-detail-item {
    padding: 15px;
    border-radius: 10px; margin-bottom: 15px;
    background: var(--light-gray-bg);
    border-left: 4px solid var(--primary);
  }
  .balance-detail-item h3 {
    margin-top: 0;
    margin-bottom: 10px; color: var(--dark);
    display: flex; align-items: center; gap: 8px;
  }
  .balance-detail-item h3 i { color: var(--primary); }
  .balance-detail-item p { margin: 8px 0; }
  .balance-detail-item strong { color: var(--dark); }
  
  .flex-group {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }
  .flex-group .form-group {
    flex: 1;
  }

  /* Modals */
  .modal {
    display: none; position: fixed; z-index: 1000; left: 0;
    top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0, 0, 0, 0.6); align-items: center;
    justify-content: center; backdrop-filter: blur(3px);
    animation: fadeIn 0.3s ease;
  }
  .modal.active { display: flex; }
  .modal-content {
    background-color: var(--card-bg);
    margin: auto; padding: 30px; border-radius: 16px;
    width: 90%; max-width: 600px; box-shadow: var(--shadow-hover); position: relative;
    animation: slideUp 0.4s ease;
    max-height: 90vh;
    overflow-y: auto;
    border-top: 4px solid var(--primary);
  }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .close-button {
    color: var(--gray); position: absolute;
    right: 20px; top: 20px; font-size: 28px;
    font-weight: bold; cursor: pointer; transition: var(--transition);
  }
  .close-button:hover { color: var(--danger); transform: rotate(90deg); }
  .modal h2 { margin-top: 0; color: var(--primary); padding-right: 30px; }
  .modal .btn-container { display: flex; justify-content: flex-end;
    gap: 12px; margin-top: 25px; }

  /* Outros */
  .btn {
    padding: 12px 20px; background: var(--primary);
    color: white; border: none;
    border-radius: 10px; font-weight: 500; cursor: pointer; transition: var(--transition);
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    font-size: 0.95rem;
    background: linear-gradient(to right, var(--primary), var(--primary-light));
  }
  .btn:hover { 
    background: linear-gradient(to right, var(--primary-light), var(--primary));
    transform: translateY(-2px); box-shadow: var(--shadow); 
  }
  .btn-xs { padding: 4px 10px; font-size: 0.75rem; border-radius: 6px; }
  .btn-danger { background: var(--danger); }
  .btn-danger:hover { background: #ff1e4a; }
  .btn-success { background: var(--success); }
  .btn-success:hover { background: #1aa34a; }
  .chart-container { width: 100%; height: 320px; margin: 20px auto; }
  .progress-bar { width: 100%; background-color: var(--gray-light); border-radius: 5px; height: 10px; overflow: hidden; }
  .progress-bar div { height: 100%; background: linear-gradient(to right, var(--primary), var(--primary-light)); border-radius: 5px; }
  
  /* ===== ESTILOS PARA FILTROS ===== */
  .filters-container {
    padding: 15px;
    margin-bottom: 15px;
    background: var(--light-gray-bg);
    border-radius: 12px;
    border: 1px solid var(--gray-light);
    border-left: 4px solid var(--primary);
  }
  
  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }
  
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  
  .filter-group label {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--dark);
  }
  
  .filter-group input, 
  .filter-group select {
    padding: 10px;
    border: 1px solid var(--gray-light);
    border-radius: 8px;
    background-color: white;
    font-family: inherit;
  }
  
  .filter-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
  }
  
  .filter-checkbox input {
    margin: 0;
  }
  
  .filter-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
  }
  
  /* ===== ESTILOS PARA ABA ANÁLISE (GESTÃO) ===== */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }
  .kpi-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary);
  }
  .kpi-card-title {
    font-size: 0.9rem;
    color: var(--gray);
    margin-bottom: 8px;
  }
  .kpi-card-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--dark);
  }
  .comparison-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .comparison-item .value { font-weight: 600; }
  .top-list { list-style: none; padding: 0; }
  .top-list li {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--gray-light);
  }
  .top-list li:last-child { border-bottom: none; }
  .top-list .name { font-weight: 500; }
  .top-list .amount { font-weight: 600; color: var(--success); }
  
  /* Novos cards */
  .receipt-card, .client-card, .commitment-card, .order-card, .quote-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary);
    transition: var(--transition);
    position: relative;
  }
  .receipt-card::before,
  .client-card::before,
  .commitment-card::before,
  .order-card::before,
  .quote-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 4px;
    border-radius: 4px 0 0 4px;
  }
  
  .receipt-card:hover, .client-card:hover, .commitment-card:hover, .order-card:hover, .quote-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
  }
  
  .receipt-card { border-left-color: var(--event-blue); }
  .receipt-card::before { background: var(--event-blue); }
  .client-card { border-left-color: var(--success); }
  .client-card::before { background: var(--success); }
  .commitment-card { border-left-color: var(--event-purple); }
  .commitment-card::before { background: var(--event-purple); }
  .order-card { border-left-color: var(--event-orange); }
  .order-card::before { background: var(--event-orange); }
  /* NOVO - Estilo para card de Orçamento */
  .quote-card { border-left-color: var(--event-blue); }
  .quote-card::before { background: var(--event-blue); }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--dark);
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--gray-light);
    border-radius: 8px;
    font-family: inherit;
  }
  
  /* Modelos de documentos */
  .document-template {
    background: white;
    border-radius: 8px;
    padding: 30px;
    margin: 20px 0;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    border: 1px solid #eee;
    position: relative;
    display: none; /* Escondido por padrão */
  }
  
  .document-template::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 10px;
    background: linear-gradient(to right, var(--primary), var(--primary-light));
  }
  
  .document-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
  }
  
  .document-title {
    font-size: 1.8rem;
    color: var(--primary);
    margin-bottom: 10px;
  }
  
  .document-subtitle {
    color: var(--gray);
    font-size: 1rem;
  }
  
  .document-section {
    margin-bottom: 20px;
  }
  
  .document-section-title {
    font-size: 1.2rem;
    color: var(--primary);
    margin-bottom: 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
  }
  
  .document-footer {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
  }
  
  .signature-area {
    width: 200px;
    border-top: 1px solid #333;
    padding-top: 5px;
    text-align: center;
  }

  /* Logo Preview in Profile */
  #logo-preview {
    max-width: 150px;
    max-height: 150px;
    margin-top: 10px;
    border: 1px solid var(--gray-light);
    border-radius: 8px;
    padding: 5px;
    display: block; /* Ensures it takes its own line */
  }
  
  /* --- ESTILOS DO CALENDÁRIO --- */
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .calendar-header h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }
  .calendar-nav-btn {
    background: var(--light-gray-bg);
    border: 1px solid var(--gray-light);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: var(--transition);
  }
  .calendar-nav-btn:hover {
    background: var(--primary);
    color: white;
  }
  .calendar-grid, .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  .calendar-weekdays div {
    text-align: center;
    font-weight: 600;
    color: var(--gray);
    padding: 10px 0;
  }
  .calendar-day {
    text-align: center;
    padding: 10px 5px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
  }
  .calendar-day:not(.empty-day):hover {
    background-color: var(--light-gray-bg);
    transform: scale(1.05);
  }
  .current-day {
    background-color: var(--primary);
    color: white;
    font-weight: 700;
  }
  .empty-day {
    opacity: 0.3;
    cursor: default;
  }
  .has-commitment::after {
    content: '';
    position: absolute;
    bottom: 6px;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--accent);
  }
  .current-day.has-commitment::after {
    background-color: white;
  }
  #calendar-commitments-modal .commitment-item {
    padding: 15px;
    border-left: 5px solid var(--gray);
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: var(--light-gray-bg);
    transition: border-color 0.3s ease;
  }
  #calendar-commitments-modal .commitment-item:last-child {
    border-bottom: none;
  }
  
  /* Cores por status no modal de Agenda do calendário */
  .commitment-item.agendado { border-left-color: var(--warning); }
  .commitment-item.confirmado { border-left-color: var(--primary); }
  .commitment-item.realizado { border-left-color: var(--success); }
  .commitment-item.cancelado { border-left-color: var(--danger); }
  
  #view-order-modal-body .detail-group, #view-quote-modal-body .detail-group {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
  }
  #view-order-modal-body .detail-group:last-child, #view-quote-modal-body .detail-group:last-child {
      border-bottom: none;
  }
  #view-order-modal-body h4, #view-quote-modal-body h4 {
      color: var(--primary);
      margin-bottom: 8px;
  }
  #view-order-modal-body p, #view-quote-modal-body p {
      margin: 4px 0;
      font-size: 0.95rem;
  }
  #view-order-modal-body strong, #view-quote-modal-body strong {
      color: var(--dark);
      margin-right: 5px;
  }
  #view-order-modal-body ul, #view-quote-modal-body ul {
    list-style-type: none;
    padding-left: 10px;
  }
  #view-order-modal-body ul li, #view-quote-modal-body ul li {
    margin-bottom: 4px;
  }
  .quote-status {
    font-size: 0.9rem;
    font-weight: 500;
    padding: 5px 12px;
    border-radius: 20px;
    color: white;
    margin-top: 10px;
    display: inline-block;
  }
  .quote-status.aprovado { background-color: var(--success); }
  .quote-status.pendente { background-color: var(--warning); }
  .quote-status.recusado { background-color: var(--danger); }

  .order-service-item {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }

@media (max-width: 768px) {
    .filters-grid, .kpi-grid, .comparison-grid {
      grid-template-columns: 1fr; 
    }
    
    .summary-cards {
      grid-template-columns: 1fr;
    }
    
    .filter-actions {
      flex-direction: column; 
    }
    
    .feature-grid { grid-template-columns: 1fr 1fr; }
    .main-content { padding: 75px 15px 90px; }
    .balance-detail-item { padding: 10px; }
    
    .modal-content {
      padding: 20px; 
    }
    
    .document-footer {
      flex-direction: column;
      gap: 20px; 
    }
    
    .signature-area {
      width: 100%; 
    }
    .flex-group {
      flex-direction: column;
      gap: 0;
    }
  }

</style>
</head>
<body>
<div class="app-container">
  
  <header class="top-bar">
    <button class="icon-button" id="back-button" style="display: none;"><i class="fas fa-arrow-left"></i></button>
    <h1 class="page-title" id="page-title">Início</h1>
    <button class="icon-button"><i class="far fa-comment"></i></button>
  </header>

  <main class="main-content">
    
    <div class="tab-content active" id="dashboard-content">
      <div class="feature-grid">
        <div class="feature-item" data-tab-target="transacoes"><i class="fas fa-exchange-alt"></i><span>Transações</span></div>
        <div class="feature-item" data-tab-target="contas"><i class="fas fa-piggy-bank"></i><span>Contas</span></div>
        <div class="feature-item" data-tab-target="cartoes"><i class="fas fa-credit-card"></i><span>Cartões</span></div>
        <div class="feature-item" data-tab-target="metas"><i class="fas fa-bullseye"></i><span>Metas</span></div>
        <div class="feature-item" data-tab-target="relatorios"><i class="fas fa-chart-bar"></i><span>Relatórios</span></div>
        <div class="feature-item" data-tab-target="backup"><i class="fas fa-database"></i><span>Backup</span></div>
        <div class="feature-item" data-tab-target="recibos"><i class="fas fa-file-invoice"></i><span>Recibos</span></div>
        <div class="feature-item" data-tab-target="clientes"><i class="fas fa-users"></i><span>Clientes</span></div>
        <div class="feature-item" data-tab-target="Agenda"><i class="fas fa-calendar-alt"></i><span>Agenda</span></div>
      </div>

      <div class="notifications-container" id="notifications-container">
        </div>
      
      <div>
    
        <h2 class="section-title">Atalhos</h2>
        <div class="shortcuts-container">
            <div class="shortcut-item" data-action="add-new" data-type="receita"><i class="fas fa-plus"></i><span>Nova Receita</span></div>
            <div class="shortcut-item" data-action="add-new" data-type="despesa"><i class="fas fa-minus"></i><span>Nova Despesa</span></div>
            <div class="shortcut-item" data-action="add-new" data-type="transferencia"><i class="fas fa-exchange-alt"></i><span>Transferência</span></div>
            <div class="shortcut-item" data-action="add-new-goal"><i class="fas fa-bullseye"></i><span>Nova Meta</span></div>
            <div class="shortcut-item" id="add-new-receipt-btn"><i class="fas 
fa-file-invoice"></i><span>Novo Recibo</span></div>
            <a href="https://www.nfse.gov.br/EmissorNacional/Login?ReturnUrl=%2fEmissorNacional%2fDPS%2fNFSe%3fidr%3dQnVWeE9PVGFZRWc90&idr=QnVWeE9PVGFZRWc90" target="_blank" rel="noopener noreferrer" class="shortcut-item" style="text-decoration: none; color: inherit;">
              <i class="fas fa-receipt"></i><span>Nota Fiscal</span>
            </a>
            <div class="shortcut-item" id="add-new-client-btn"><i class="fas fa-user-plus"></i><span>Novo Cliente</span></div>
            <div class="shortcut-item" id="add-new-commitment-btn"><i class="fas fa-handshake"></i><span>Novo Compromisso</span></div>
            <div class="shortcut-item" data-tab-target="documentos"><i class="fas fa-file-alt"></i><span>Gerar Documentos</span></div>
            <div class="shortcut-item" data-tab-target="pedidos"><i class="fas fa-clipboard-check"></i><span>Pedidos e Orçamentos</span></div>
        </div>
      </div>
      
      <div>
        <h2 class="section-title">Resumo Financeiro</h2>
        <div class="summary-cards">
            <div class="summary-card receita" id="receita-card"><h3 class="card-title">Receitas do Mês</h3><div class="value" id="total-receitas"></div><div class="trend" id="receitas-trend"></div></div>
            <div class="summary-card despesa" id="despesa-card"><h3 class="card-title">Despesas do Mês</h3><div class="value" id="total-despesas"></div><div class="trend" id="despesas-trend"></div></div>
            <div class="summary-card saldo" id="saldo-card"><h3 class="card-title">Saldo Total</h3><div class="value" id="saldo-total"></div><div class="forecast" id="saldo-forecast"></div></div>
            <div class="summary-card balanco" id="balanco-card"><h3 class="card-title">Balanço Mensal</h3><div class="value" id="balanco-mensal"></div></div>
        </div>
      </div>
       <button class="btn main-cta-button" data-action="add-new" data-type="receita"><i class="fas fa-plus"></i> Criar Nova Transação</button>
    </div>
    
    <div class="tab-content" id="analise-content">
        <div class="card">
            <h2 class="section-title">Indicadores-Chave (KPIs) - Ano Corrente</h2>
             <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-card-title">Faturamento no Ano</div>
                    <div class="kpi-card-value" id="kpi-ytd-revenue">R$ 0,00</div>
                </div>
         <div class="kpi-card">
                    <div class="kpi-card-title">Lucro no Ano</div>
                    <div class="kpi-card-value" id="kpi-ytd-profit">R$ 0,00</div>
                </div>
                <div class="kpi-card">
         <div class="kpi-card-title">Margem de Lucro</div>
                    <div class="kpi-card-value" id="kpi-profit-margin">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-card-title">Ticket Médio</div>
         <div class="kpi-card-value" id="kpi-avg-ticket">R$ 0,00</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">Análise Comparativa</h2>
            <div class="comparison-grid">
               <div class="comparison-item">
                  <h3>Mês Atual vs. Mês Anterior</h3>
                    <p>Faturamento: <span class="value" id="comp-month-revenue"></span> <span id="comp-month-revenue-trend"></span></p>
                    <p>Despesas: <span class="value" id="comp-month-expense"></span> <span id="comp-month-expense-trend"></span></p>
               </div>
        <div class="comparison-item">
                    <h3>Ano Atual vs. Ano Anterior</h3>
                    <p>Faturamento: <span class="value" id="comp-year-revenue"></span> <span id="comp-year-revenue-trend"></span></p>
                </div>
             </div>
        </div>

        <div class="card">
           <h2 class="section-title">Maiores Faturamentos</h2>
            <div class="comparison-grid">
                <div>
                    <h3>Top 5 Clientes (por Recibos)</h3>
                   <ul class="top-list" id="top-clients-list"></ul>
                </div>
                <div>
                    <h3>Top 5 Categorias de Receita</h3>
                    <ul class="top-list" id="top-revenue-categories-list"></ul>
                 </div>
            </div>
         </div>

        <div class="card">
            <h2 class="section-title">Receita Mensal (Ano Atual vs. Ano Anterior)</h2>
            <div class="chart-container">
                <canvas id="yoy-revenue-chart"></canvas>
             </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">Tendência da Margem de Lucro (Últimos 12 Meses)</h2>
            <div class="chart-container">
                <canvas id="profit-margin-trend-chart"></canvas>
            </div>
        </div>

    </div>
    
    <div class="tab-content" id="transacoes-content">
      <div class="card">
        <h2>Transações</h2>
        <div class="filters-container">
          <div class="filters-grid">
            <div class="filter-group">
              <label for="search-input">Buscar</label>
             <input type="text" id="search-input" placeholder="Descrição...">
            </div>
        <div class="filter-group">
              <label for="type-filter">Tipo</label>
              <select id="type-filter">
                <option value="all">Todos</option>
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
                <option value="transferencia">Transferência</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="status-filter">Status</label>
              <select id="status-filter">
                <option value="all">Todos</option>
                <option value="confirmada">Confirmada</option>
                <option value="pendente">Pendente</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="start-date-filter">Data Início</label>
              <input type="date" id="start-date-filter">
             </div>
            <div class="filter-group">
              <label for="end-date-filter">Data Fim</label>
              <input type="date" id="end-date-filter">
            </div>
            <div class="filter-group">
               <div class="filter-checkbox">
                <input type="checkbox" id="expired-only">
                <label for="expired-only">Mostrar apenas vencidas</label>
              </div>
            </div>
        </div>
          <div class="filter-actions">
            <button class="btn" id="apply-filters-btn">Aplicar Filtros</button>
            <button class="btn" id="clear-filters-btn">Limpar Filtros</button>
          </div>
        </div>
        
        <div id="all-transactions-list" class="transactions-list-container"></div>
      </div>
    </div>
   
     
     <div class="tab-content" id="contas-content">
        <div class="card">
            <h2><i class="fas fa-piggy-bank"></i> Minhas Contas</h2>
            <button class="btn" style="margin-bottom:15px;" id="add-new-account-btn"><i class="fas fa-plus"></i> Adicionar Conta</button>
            <div class="table-wrapper">
                <table id="accounts-list">
                    <thead>
                        <tr>
                            <th>Conta</th>
                            <th>Saldo</th>
                            <th style="text-align:right">Ações</th>
                        </tr>
                     </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="tab-content" id="metas-content"><div class="card"><h2>Minhas Metas</h2><div id="goals-list" class="goals-container"></div></div></div>
     <div class="tab-content" id="cartoes-content"><div class="card"><h2>Meus Cartões</h2><button class="btn" style="margin-bottom:15px;" data-action="add-new-creditcard">Adicionar Cartão</button><div class="table-wrapper"><table id="creditcards-list"><thead><tr><th>Cartão</th><th>Limite</th><th>Fechamento</th><th>Vencimento</th><th style="text-align:right">Ações</th></tr></thead><tbody></tbody></table></div></div></div>
    
    <div class="tab-content" id="relatorios-content">
        <div class="card"><div class="chart-container"><canvas id="overview-chart"></canvas></div></div>
        <div class="card"><div class="chart-container"><canvas id="monthly-report-chart"></canvas></div></div>
        <div class="card"><div class="chart-container"><canvas id="category-report-chart"></canvas></div></div>
        <div class="card"><div class="chart-container"><canvas id="annual-report-chart"></canvas></div></div>

        <div class="card">
          <h2><i class="fas fa-calendar-check"></i> Relatório por Tipo de Evento</h2>
          <div class="form-group">
            <label for="event-type-report-filter">Selecione o Tipo de Evento</label>
            <select id="event-type-report-filter">
              <option value="">-- Todos --</option>
            </select>
          </div>
          <div class="table-wrapper" style="margin-top: 20px;">
            <table id="event-type-report-table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Data do Evento</th>
                        <th>Valor do Pedido</th>
                    </tr>
                </thead>
                <tbody id="event-type-report-results">
                    </tbody>
            </table>
          </div>
        </div>
    </div>

    <div class="tab-content" id="usuario-content"><div class="card"><form id="user-info-form"><h2>Minhas Informações</h2><div class="form-group"><label for="user-name">Nome</label><input type="text" id="user-name"/></div><div class="form-group"><label for="user-cpf">CPF/CNPJ</label><input type="text" id="user-cpf"/></div><div class="form-group"><label for="user-logo">Logo da Empresa (recomendado: imagem pequena)</label><input type="file" id="user-logo" accept="image/*"/> <img id="logo-preview" src="#" alt="Prévia da Logo" style="display: none;"/></div><div style="text-align:right;"><button type="submit" class="btn">Salvar</button></div><div id="user-info-message"></div></form></div></div>
    <div class="tab-content" id="backup-content"><div class="card"><h2>Backup e Restauração</h2><p>Exporte seus dados para um arquivo seguro ou importe um backup para restaurar suas informações.</p><div style="margin-top:20px; display:flex; gap: 15px;"><button class="btn" id="export-backup-btn">Exportar Dados</button><button class="btn" id="import-trigger-btn">Importar Dados</button><input type="file" id="import-backup-input" accept=".json" style="display:none;"/></div><div id="backup-message" style="margin-top:15px; font-weight:500;"></div></div></div>
    
    <div class="tab-content" id="recibos-content">
      <div class="card">
        <h2><i class="fas fa-file-invoice"></i> Recibos</h2>
        <button class="btn" style="margin-bottom:15px;" id="add-receipt-btn-aba"><i class="fas fa-plus"></i> Novo Recibo</button>
        <div id="receipts-list" class="transactions-list-container"></div>
      </div>
    </div>
    
    <div class="tab-content" id="clientes-content">
      <div class="card">
        <h2><i class="fas fa-users"></i> Clientes</h2>
        <button class="btn" style="margin-bottom:15px;" id="add-client-btn-aba"><i class="fas fa-plus"></i> Novo Cliente</button>
        <div id="clients-list" class="transactions-list-container"></div>
      </div>
    </div>
    
    <div class="tab-content" id="Agenda-content">
      <div class="card">
        <h2><i class="fas fa-calendar-alt"></i> Calendário de Agenda</h2>
        <div id="calendar-container"></div>
      </div>

      <div>
        <h2 class="section-title">Lista de Agenda do Mês</h2>
        <button class="btn" style="margin-bottom:15px;" id="add-commitment-btn-aba"><i class="fas fa-plus"></i> Novo Compromisso</button>
        <div id="commitments-list" class="transactions-list-container"></div>
      </div>
    </div>
    
    <div class="tab-content" id="pedidos-content">
      <div class="card">
        <h2><i class="fas fa-clipboard-check"></i> Meus Pedidos e Orçamentos</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn" id="add-new-order-btn-aba"><i class="fas fa-plus"></i> Novo Pedido</button>
            <button class="btn" id="add-new-quote-btn-aba" style="background: var(--event-blue);"><i class="fas fa-plus"></i> Novo Orçamento</button>
        </div>
        <div class="filters-container">
            <div class="filters-grid">
               <div class="filter-group">
                <label for="search-orders-input">Buscar</label>
                <input type="text" id="search-orders-input" placeholder="Nome do cliente ou nº...">
              </div>
              <div class="filter-group">
                <label for="type-orders-filter">Tipo</label>
                <select id="type-orders-filter">
                    <option value="all">Todos</option>
                    <option value="order">Pedidos</option>
                    <option value="quote">Orçamentos</option>
                </select>
              </div>
            </div>
            <div class="filter-actions" style="margin-top: 15px;">
                <button class="btn" id="apply-orders-filter-btn">Aplicar Filtros</button>
                <button class="btn" id="clear-orders-filter-btn">Limpar Filtros</button>
            </div>
        </div>
        <div id="orders-list" class="transactions-list-container" style="margin-top: 20px;"></div>
      </div>
    </div>

    <div class="tab-content" id="documentos-content">
      <div class="card" id="document-generation-card" style="margin-bottom: 25px;">
          <h2><i class="fas fa-file-signature"></i> Gerar Novo Documento</h2>
          <p>Selecione o tipo de documento que deseja criar.</p>
          <div class="shortcuts-container" style="padding-bottom: 0; margin-top: 15px;">
             <div class="shortcut-item" id="generate-dj-contract-doc-tab"><i class="fas fa-file-contract"></i><span>Contrato DJ</span></div>
             <div class="shortcut-item" id="generate-event-order-doc-tab"><i class="fas fa-clipboard-list"></i><span>Pedido de Evento</span></div>
             <div class="shortcut-item" id="generate-event-quote-doc-tab"><i class="fas fa-file-alt"></i><span>Orçamento</span></div>
          </div>
      </div>

      <div class="card">
        <h2 style="display:none;"><i class="fas fa-file-alt"></i> Documentos</h2>
        
        <div class="document-template" id="dj-contract-template">
         
         <div class="document-header">
            <h1 class="document-title">CONTRATO DE PRESTAÇÃO DE SERVIÇOS DE DJ</h1>
            <p class="document-subtitle">Entre as partes abaixo qualificadas</p>
          </div>
          
          <div class="document-section">
            <h2 class="document-section-title">1. DAS PARTES CONTRATANTES</h2>
             <p><strong>CONTRATANTE:</strong> <span id="contract-client-name"></span>, 
inscrito(a) no CPF/CNPJ nº <span id="contract-client-doc"></span>, residente e domiciliado(a) em <span id="contract-client-address"></span>.</p>
            <p><strong>CONTRATADO:</strong> <span id="contract-company-name"></span>, inscrito(a) no CPF/CNPJ nº <span id="contract-company-doc"></span>, doravante denominado simplesmente "DJ".</p>
          </div>
          
          <div class="document-section">
            <h2 class="document-section-title">2. DO OBJETO</h2>
            <p>O presente contrato tem por objeto a prestação de serviços de Disc Jockey (DJ) para o evento a ser realizado em <span id="contract-event-location"></span>, no dia <span id="contract-event-date"></span>, com início às <span id="contract-event-start"></span> e término às <span id="contract-event-end"></span>.</p>
          </div>
          
          <div class="document-section">
            <h2 class="document-section-title">3. DAS OBRIGAÇÕES DO CONTRATADO</h2>
            <ul>
              <li>Fornecer todo o equipamento necessário para a realização do serviço;</li>
              <li>Comparecer no local e horário combinados;</li>
              <li>Executar o repertório conforme combinado com o contratante;</li>
              <li>Manter comportamento profissional durante todo o evento.</li>
 
           </ul>
          </div>
          
          <div class="document-section">
            <h2 class="document-section-title">4. DAS OBRIGAÇÕES DO CONTRATANTE</h2>
            <ul>
              <li>Fornecer espaço adequado e energia elétrica para os equipamentos;</li>
              <li>Efetuar o pagamento conforme cláusula 5;</li>
              <li>Informar com antecedência qualquer alteração no evento.</li>
            </ul>
          </div>
  
         
          <div class="document-section">
            <h2 class="document-section-title">5. DO VALOR E FORMA DE PAGAMENTO</h2>
            <p>5.1. O valor total do serviço é de <span id="contract-total-value"></span> (<span id="contract-total-value-extenso"></span>), a ser pago da seguinte forma:</p>
            <ul>
              <li><span id="contract-payment-1"></span>% no ato da assinatura deste contrato;</li>
              <li><span id="contract-payment-2"></span>% até 7 dias antes do evento;</li>
              <li><span id="contract-payment-3"></span>% no dia do evento, antes do início dos trabalhos.</li>
      
           </ul>
          </div>
          
          <div class="document-section">
            <h2 class="document-section-title">6. DAS PENALIDADES</h2>
            <p>6.1. Em caso de desistência pelo contratante:</p>
            <ul>
              <li>Até 30 dias antes do evento: devolução de 50% do valor pago;</li>
              <li>Até 15 dias antes do evento: devolução de 25% do valor pago;</li>
              <li>Após este prazo: não haverá devolução.</li>
            </ul>
  
           <p>6.2. Em caso de não comparecimento do DJ, este devolverá o dobro do valor recebido.</p>
          </div>
          
          <div class="document-section">
            <h2 class="document-section-title">7. DISPOSIÇÕES FINAIS</h2>
            <p>7.1. O presente contrato é válido apenas para o evento especificado.</p>
            <p>7.2. Quaisquer alterações deverão ser feitas por escrito e assinadas por ambas as partes.</p>
            <p>7.3. Fica eleito o foro da comarca de <span id="contract-legal-place"></span> para dirimir quaisquer dúvidas decorrentes deste contrato.</p>
          </div>
          
          <div class="document-footer">
            <div class="signature-area">
              <p>___________________________</p>
              <p>Contratante</p>
            </div>
 
           <div class="signature-area">
              <p>___________________________</p>
              <p>Contratado (DJ)</p>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button class="btn" id="download-dj-contract"><i class="fas fa-download"></i> Baixar Contrato</button>
          </div>
        </div>
        
        <div class="document-template" id="event-order-template">
          <div class="document-header">
            <h1 class="document-title">PEDIDO DE SERVIÇOS PARA EVENTO</h1>
            <p class="document-subtitle">Nº <span id="order-number"></span></p>
          </div>
      
        
          <div class="document-section">
            <h2 class="document-section-title">1. DADOS DO CLIENTE</h2>
            <p><strong>Nome:</strong> <span id="order-client-name"></span></p>
            <p><strong>CPF/CNPJ:</strong> <span id="order-client-doc"></span></p>
            <p><strong>Telefone:</strong> <span id="order-client-phone"></span></p>
            <p><strong>Email:</strong> <span id="order-client-email"></span></p>
          </div>
          
          <div class="document-section">
         <h2 class="document-section-title">2. DETALHES DO EVENTO</h2>
            <p><strong>Tipo de Evento:</strong> <span id="order-event-type"></span></p>
            <p><strong>Data:</strong> <span id="order-event-date"></span></p>
            <p><strong>Horário:</strong> <span id="order-event-time"></span></p>
            <p><strong>Local:</strong> <span id="order-event-location"></span></p>
            <p><strong>Nº de Convidados:</strong> <span id="order-event-guests"></span></p>
          </div>
          
 
           <div class="document-section">
            <h2 class="document-section-title">3. SERVIÇOS CONTRATADOS</h2>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f5f5f5;">
                  <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Item</th>
                  <th style="padding: 10px; text-align: left; 
border-bottom: 1px solid #ddd;">Descrição</th>
                  <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Valor</th>
                </tr>
              </thead>
              <tbody id="order-services-list">
                </tbody>
              <tfoot>
                <tr>
                  <td colspan="2" style="padding: 10px; text-align: right; font-weight: bold; border-top: 2px solid #ddd;">Total</td>
                  <td style="padding: 10px; text-align: right; font-weight: bold; border-top: 2px solid #ddd;" id="order-total-value"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          
          <div class="document-section">
            <h2 class="document-section-title">4. CONDIÇÕES DE PAGAMENTO</h2>
            <p><span id="order-payment-terms"></span></p>
          </div>
          
          <div class="document-section">
            <h2 class="document-section-title">5. OBSERVAÇÕES</h2>
            <p><span id="order-notes"></span></p>
          </div>
          
          <div class="document-footer">
            <div class="signature-area">
              <p>___________________________</p>
              <p>Cliente</p>
            </div>
   
           <div class="signature-area">
              <p>___________________________</p>
              <p>Responsável</p>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button class="btn" id="download-event-order"><i class="fas 
fa-download"></i> Baixar Pedido</button>
          </div>
        </div>

        <div class="document-template" id="event-quote-template">
          <div class="document-header">
            <h1 class="document-title">ORÇAMENTO DE SERVIÇOS</h1>
            <p class="document-subtitle">Nº <span id="quote-number"></span></p>
          </div>

          <div class="document-section">
            <h2 class="document-section-title">1. DADOS DO CLIENTE</h2>
            <p><strong>Nome:</strong> <span id="quote-client-name"></span></p>
            <p><strong>Telefone:</strong> <span id="quote-client-phone"></span></p>
            <p><strong>Email:</strong> <span id="quote-client-email"></span></p>
          </div>

          <div class="document-section">
            <h2 class="document-section-title">2. DETALHES DO EVENTO</h2>
            <p><strong>Tipo de Evento:</strong> <span id="quote-event-type"></span></p>
            <p><strong>Data:</strong> <span id="quote-event-date"></span></p>
            <p><strong>Horário:</strong> <span id="quote-event-time"></span></p>
            <p><strong>Local:</strong> <span id="quote-event-location"></span></p>
          </div>

          <div class="document-section">
            <h2 class="document-section-title">3. SERVIÇOS INCLUSOS</h2>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f5f5f5;">
                  <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Descrição</th>
                  <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Valor</th>
                </tr>
              </thead>
              <tbody id="quote-services-list"></tbody>
              <tfoot>
                <tr>
                  <td style="padding: 10px; text-align: right; font-weight: bold; border-top: 2px solid #ddd;">Total</td>
                  <td style="padding: 10px; text-align: right; font-weight: bold; border-top: 2px solid #ddd;" id="quote-total-value"></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="document-section">
            <h2 class="document-section-title">4. CONDIÇÕES GERAIS</h2>
            <p>Este orçamento é válido por <span id="quote-validity"></span> dias a partir da data de emissão. O valor está sujeito a alterações após este período. A contratação do serviço se dará mediante a assinatura de contrato e/ou pagamento de sinal.</p>
            <p style="margin-top: 10px;"><strong>Observações:</strong> <span id="quote-notes"></span></p>
          </div>

          <div style="text-align: center; margin-top: 30px;">
            <button class="btn" id="download-event-quote"><i class="fas fa-download"></i> Baixar Orçamento</button>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <nav class="bottom-nav">
    <button class="bottom-nav-item active" data-tab-target="dashboard"><i class="fas fa-home"></i><span>Início</span></button>
    <button class="bottom-nav-item" data-tab-target="analise"><i class="fas fa-chart-pie"></i><span>Análise</span></button>
    <button class="bottom-nav-item" data-tab-target="usuario"><i class="fas fa-user-circle"></i><span>Perfil</span></button>
  </nav>

  <datalist id="categories-list"></datalist>

  <div id="transaction-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="transaction-modal-title">Nova Transação</h2>
      <form id="transaction-form">
 
        <input type="hidden" id="edit-transaction-id">
        <div class="form-group">
          <label for="transaction-type">Tipo</label>
          <select id="transaction-type" required>
            <option value="receita">Receita</option>
            <option value="despesa">Despesa</option>
            <option value="transferencia">Transferência</option>
          </select>
        </div>
  
        <div class="form-group">
          <label for="transaction-amount">Valor (R$)</label>
          <input type="number" id="transaction-amount" step="0.01" min="0.01" placeholder="Ex: 150.00" required>
        </div>
        <div class="form-group">
          <label for="transaction-date">Data</label>
          <input type="date" id="transaction-date" required>
        </div>
        <div class="form-group">
      
        <label for="transaction-description">Descrição</label>
          <input type="text" id="transaction-description" placeholder="Ex: Pagamento do evento X" required>
        </div>
        <div class="form-group">
          <label for="transaction-category">Categoria</label>
          <input type="text" id="transaction-category" list="categories-list" placeholder="Ex: Salário" required>
        </div>
        <div class="form-group" id="from-account-group" style="display: none;">
          <label for="from-account">Conta de 
Origem</label>
          <select id="from-account"></select>
        </div>
        <div class="form-group" id="transfer-target-type-group" style="display: none;">
          <label for="transfer-target-type">Destino da Transferência</label>
          <select id="transfer-target-type">
            <option value="account">Conta</option>
            <option value="goal">Meta</option>
          </select>
        </div>
 
        <div class="form-group">
          <label for="to-account">Conta</label>
          <select id="to-account" required></select>
        </div>
        <div class="form-group filter-checkbox">
          <input type="checkbox" id="transaction-status" checked>
          <label for="transaction-status">Confirmada (se desmarcado, fica pendente)</label>
        </div>
        <div class="btn-container">
      
        <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="account-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" data-action="close-modal">&times;</span>
        <h2 id="account-modal-title">Nova Conta</h2>
        <form id="account-form">
            <input type="hidden" id="edit-account-id">
        
        <div class="form-group">
                <label for="account-name">Nome da Conta</label>
                <input type="text" id="account-name" required>
            </div>
            <div class="form-group">
                <label for="account-type">Tipo de Conta</label>
             
           <select id="account-type">
                    <option value="carteira">Carteira</option>
                    <option value="conta_corrente">Conta Corrente</option>
                    <option value="poupanca">Poupança</option>
                    <option value="investimento">Investimento</option>
           
         </select>
            </div>
            <div class="form-group" id="balance-group">
                <label for="account-balance">Saldo (R$)</label>
                <input type="number" id="account-balance" step="0.01" placeholder="0.00">
            </div>
            <div class="btn-container">
    
                <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
                <button type="submit" class="btn">Salvar</button>
            </div>
        </form>
    </div>
  </div>
  
  <div id="goal-modal" class="modal">
      <div class="modal-content">
          <span class="close-button" data-action="close-modal">&times;</span>
          <h2 id="goal-modal-title">Nova Meta</h2>
   
           <form id="goal-form-modal">
              <input type="hidden" id="edit-goal-id">
              <div class="form-group">
                  <label for="modal-goal-name">Nome da Meta</label>
                  <input type="text" id="modal-goal-name" required>
              </div>
     
             <div class="form-group">
                  <label for="modal-goal-amount">Valor Alvo (R$)</label>
                  <input type="number" id="modal-goal-amount" step="0.01" min="0.01" required>
              </div>
              <div class="form-group">
                 
                 <label for="modal-goal-date">Data Limite</label>
                  <input type="date" id="modal-goal-date" required>
              </div>
              <div class="btn-container">
                  <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
                  <button type="submit" class="btn">Salvar</button>
     
             </div>
          </form>
      </div>
  </div>

  <div id="creditcard-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="creditcard-modal-title">Novo Cartão de Crédito</h2>
      <form id="creditcard-form">
        <input type="hidden" id="edit-creditcard-id">
        <div class="form-group">
          <label for="creditcard-name">Nome do Cartão (Ex: Nubank Final 1234)</label>
   
           <input type="text" id="creditcard-name" required>
        </div>
        <div class="form-group">
          <label for="creditcard-limit">Limite (R$)</label>
          <input type="number" id="creditcard-limit" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="creditcard-closing-day">Dia do Fechamento da Fatura</label>
          <input type="number" id="creditcard-closing-day" min="1" 
max="31" required>
        </div>
        <div class="form-group">
          <label for="creditcard-due-day">Dia do Vencimento da Fatura</label>
          <input type="number" id="creditcard-due-day" min="1" max="31" required>
        </div>
        <div class="btn-container">
          <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn">Salvar</button>
        </div>
 
      </form>
    </div>
  </div>

  <div id="receipt-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="receipt-modal-title">Novo Recibo</h2>
      <form id="receipt-form">
        <input type="hidden" id="edit-receipt-id">
        <div class="form-group">
          <label for="receipt-client">Cliente</label>
          <select id="receipt-client" required></select>
        </div>
       
        <div class="form-group" id="receipt-order-group" style="display: none;">
          <label for="receipt-order">Vincular ao Pedido (Opcional)</label>
          <select id="receipt-order"></select>
        </div>
         <div class="form-group">
          <label for="receipt-account-destination">Conta de Destino</label>
          <select id="receipt-account-destination" required></select>
        </div>
        <div class="form-group">
          
        <label for="receipt-amount">Valor (R$)</label>
          <input type="number" id="receipt-amount" step="0.01" min="0.01" required>
        </div>
        <div class="form-group">
          <label for="receipt-description">Descrição do Serviço</label>
          <textarea id="receipt-description" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label for="receipt-date">Data de Emissão</label>
          
        <input type="date" id="receipt-date" required>
        </div>
        <div class="form-group">
          <label for="receipt-status">Status</label>
          <select id="receipt-status" required>
            <option value="emitido">Emitido</option>
            <option value="pago">Pago</option>
            <option value="cancelado">Cancelado</option>
          </select>
        
        </div>
        <div class="btn-container">
          <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn">Salvar</button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="client-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="client-modal-title">Novo Cliente</h2>
      <form id="client-form">
        <input type="hidden" id="edit-client-id">
 
           <div class="form-group">
          <label for="client-name">Nome Completo</label>
          <input type="text" id="client-name" required>
        </div>
        <div class="form-group">
          <label for="client-email">Email</label>
          <input type="email" id="client-email">
        </div>
        <div class="form-group">
          
        <label for="client-phone">Telefone</label>
          <input type="tel" id="client-phone">
        </div>
        <div class="form-group">
          <label for="client-document">CPF/CNPJ</label>
          <input type="text" id="client-document">
        </div>
        <div class="form-group">
          <label for="client-birthday">Data de Nascimento</label>
          <input type="date" id="client-birthday">
     
       </div>
        <div class="form-group">
          <label for="client-address">Endereço</label>
          <input type="text" id="client-address">
        </div>
        <div class="btn-container">
          <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn">Salvar</button>
        </div>
      </form>
    </div>
  </div>
  
 
  <div id="commitment-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="commitment-modal-title">Novo Compromisso</h2>
      <form id="commitment-form">
        <input type="hidden" id="edit-commitment-id">
        <div class="form-group">
          <label for="commitment-title">Título do Compromisso</label>
          <input type="text" id="commitment-title" required>
        </div>
        <div class="form-group">
      
        <label for="commitment-client">Cliente (Opcional)</label>
          <select id="commitment-client"></select>
        </div>
        <div class="form-group">
          <label for="commitment-date">Data e Hora</label>
          <input type="datetime-local" id="commitment-date" required>
        </div>
        <div class="form-group">
          <label for="commitment-location">Local</label>
          <input type="text" 
id="commitment-location">
        </div>
        <div class="form-group">
          <label for="commitment-description">Descrição/Observações</label>
          <textarea id="commitment-description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="commitment-status">Status</label>
          <select id="commitment-status" required>
            <option value="agendado">Agendado</option>
       
         <option value="confirmado">Confirmado</option>
            <option value="realizado">Realizado</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
        <div class="btn-container">
          <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn">Salvar</button>
        </div>
      </form>
 
    </div>
  </div>
  
  <div id="balance-detail-modal" class="modal">
      <div class="modal-content">
          <span class="close-button" data-action="close-modal">&times;</span>
          <h2>Detalhes do Balanço Mensal</h2>
          <div id="balance-detail-content">
              </div>
      </div>
  </div>
  
  <div id="dj-contract-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
     
      <h2>Gerar Contrato de DJ</h2>
      <form id="dj-contract-form">
        <div class="flex-group">
            <div class="form-group">
              <label for="contract-client-select">Cliente</label>
              <select id="contract-client-select" required>
                <option value="">Selecione um cliente</option>
              </select>
            </div>
            <button type="button" class="btn" id="add-client-from-contract-btn" style="width: auto;"><i class="fas fa-user-plus"></i></button>
        </div>
        
        <div class="form-group" id="contract-order-selector-group" style="display: none;">
    
            <label for="contract-order-select">Carregar dados do Pedido (Opcional)</label>
            <select id="contract-order-select">
                <option value="">-- Selecione um Pedido --</option>
            </select>
        </div>

        <div class="form-group">
          <label for="contract-event-location-input">Local do Evento</label>
          <input 
type="text" id="contract-event-location-input" required>
        </div>
        
        <div class="form-group">
          <label for="contract-event-date-input">Data do Evento</label>
          <input type="date" id="contract-event-date-input" required>
        </div>
        
        <div class="form-group">
          <label for="contract-event-start-input">Horário de Início</label>
         
         <input type="time" id="contract-event-start-input" required>
        </div>
        
        <div class="form-group">
          <label for="contract-event-end-input">Horário de Término</label>
          <input type="time" id="contract-event-end-input" required>
        </div>
        
        <div class="form-group">
          <label for="contract-total-value-input">Valor Total</label>
        
          <input type="number" id="contract-total-value-input" step="0.01" min="0.01" required>
        </div>
        
        <div class="form-group">
          <label for="contract-payment-1-input">% Sinal</label>
          <input type="number" id="contract-payment-1-input" min="0" max="100" value="30" required>
        </div>
        
        <div class="form-group">
          <label for="contract-payment-2-input">% 2ª Parcela</label>
  
            <input type="number" id="contract-payment-2-input" min="0" max="100" value="40" required>
        </div>
        
        <div class="form-group">
          <label for="contract-payment-3-input">% Final</label>
          <input type="number" id="contract-payment-3-input" min="0" max="100" value="30" required>
        </div>
        
        <div class="form-group">
        
          <label for="contract-legal-place-input">Foro Legal</label>
          <input type="text" id="contract-legal-place-input" value="São Paulo/SP" required>
        </div>
        
        <div class="btn-container">
          <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn">Gerar Contrato</button>
        </div>
      </form>
    </div>
  </div>

  <div id="event-order-modal" class="modal">
    <div 
class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="event-order-modal-title">Gerar Pedido de Evento</h2>
      <form id="event-order-form">
        <input type="hidden" id="edit-order-id">
        <div class="flex-group">
          <div class="form-group">
            <label for="order-client-select">Cliente</label>
            <select id="order-client-select" required>
              <option value="">Selecione um cliente</option>
            </select>
          </div>
          <button type="button" class="btn" id="add-client-from-order-btn" style="width: auto;"><i class="fas fa-user-plus"></i></button>
        </div>
        
        <div class="form-group">
          <label for="order-event-type-input">Tipo de Evento</label>
          <select id="order-event-type-input" required>
            <option value="Casamento">Casamento</option>
            <option value="Aniversário">Aniversário</option>
            <option value="Corporativo">Corporativo</option>
            <option value="Formatura">Formatura</option>
      
            <option value="Outro">Outro</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="order-event-date-input">Data do Evento</label>
          <input type="date" id="order-event-date-input" required>
        </div>
        
        <div class="form-group">
       
           <label for="order-event-time-input">Horário</label>
          <input type="text" id="order-event-time-input" value="19:00 às 02:00" required>
        </div>
        
        <div class="form-group">
          <label for="order-event-location-input">Local</label>
          <input type="text" id="order-event-location-input" required>
        </div>
        
        <div class="form-group">
      
            <label for="order-event-guests-input">Nº de Convidados</label>
          <input type="number" id="order-event-guests-input" min="1" value="100">
        </div>
        
        <div class="form-group">
          <label>Serviços</label>
          <div id="order-services-container">
            </div>
          <button type="button" class="btn btn-xs" id="add-service-btn" style="margin-top: 5px;"><i class="fas fa-plus"></i> Adicionar Serviço</button>
 
        </div>
        
        <div class="form-group">
          <label for="order-payment-terms-input">Condições de Pagamento</label>
          <textarea id="order-payment-terms-input" rows="3">50% no ato e 50% até 7 dias antes do evento.</textarea>
        </div>
        
        <div class="form-group">
          <label for="order-notes-input">Observações</label>
     
           <textarea id="order-notes-input" rows="3"></textarea>
        </div>
        
        <div class="btn-container">
          <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn">Salvar Pedido</button>
        </div>
      </form>
    </div>
  </div>

  <div id="event-quote-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="event-quote-modal-title">Novo Orçamento</h2>
      <form id="event-quote-form">
        <input type="hidden" id="edit-quote-id">
        <div class="flex-group">
          <div class="form-group">
            <label for="quote-client-select">Cliente</label>
            <select id="quote-client-select" required>
              <option value="">Selecione um cliente</option>
            </select>
          </div>
          <button type="button" class="btn" id="add-client-from-quote-btn" style="width: auto;"><i class="fas fa-user-plus"></i></button>
        </div>
        <div class="form-group">
          <label for="quote-event-type-input">Tipo de Evento</label>
          <select id="quote-event-type-input" required>
            <option value="Casamento">Casamento</option>
            <option value="Aniversário">Aniversário</option>
            <option value="Corporativo">Corporativo</option>
            <option value="Formatura">Formatura</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="quote-event-date-input">Data do Evento</label>
          <input type="date" id="quote-event-date-input" required>
        </div>
        <div class="form-group">
          <label for="quote-event-time-input">Horário</label>
          <input type="text" id="quote-event-time-input" value="19:00 às 02:00" required>
        </div>
        <div class="form-group">
          <label for="quote-event-location-input">Local</label>
          <input type="text" id="quote-event-location-input" required>
        </div>
        <div class="form-group">
          <label>Serviços</label>
          <div id="quote-services-container"></div>
          <button type="button" class="btn btn-xs" id="add-service-quote-btn" style="margin-top: 5px;"><i class="fas fa-plus"></i> Adicionar Serviço</button>
        </div>
        <div class="form-group">
            <label for="quote-notes-input">Observações</label>
            <textarea id="quote-notes-input" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label for="quote-validity-input">Validade (dias)</label>
            <input type="number" id="quote-validity-input" min="1" value="30" required>
        </div>
        <div class="btn-container">
          <button type="button" class="btn btn-danger" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn">Salvar Orçamento</button>
        </div>
      </form>
    </div>
  </div>

  <div id="calendar-commitments-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
    
      <h2 id="calendar-modal-title">Agenda do Dia</h2>
      <div id="calendar-modal-body"></div>
    </div>
  </div>

  <div id="view-order-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="view-order-modal-title">Detalhes do Pedido</h2>
      <div id="view-order-modal-body"></div>
      <div class="btn-container">
          <button type="button" class="btn" id="view-order-modal-download-btn"><i class="fas fa-download"></i> Baixar PDF</button>
          <button type="button" class="btn btn-danger" data-action="close-modal">Fechar</button>
      </div>
    </div>
  </div>

  <div id="view-quote-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" data-action="close-modal">&times;</span>
      <h2 id="view-quote-modal-title">Detalhes do Orçamento</h2>
      <div id="view-quote-modal-body"></div>
      <div class="btn-container" style="justify-content: space-between;">
        <div style="display:flex; gap: 10px;">
          <button type="button" class="btn" id="view-quote-modal-download-btn"><i class="fas fa-download"></i> Baixar PDF</button>
          <button type="button" class="btn btn-success" id="view-quote-modal-approve-btn"><i class="fas fa-check"></i> Aprovar e Converter em Pedido</button>
          <button type="button" class="btn btn-danger" id="view-quote-modal-reject-btn"><i class="fas fa-times"></i> Recusar Orçamento</button>
        </div>
        <button type="button" class="btn btn-danger" data-action="close-modal">Fechar</button>
      </div>
    </div>
  </div>

</div>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- MODELO DE DADOS E VARIÁVEIS GLOBAIS ---
  let accounts = parseLocalStorage('accounts', [{id: 1, name: "Carteira", type: "carteira", initialBalance: 150, balance: 150}]);
  let transactions = parseLocalStorage('transactions', []);
  let goals = parseLocalStorage('goals', []);
  let creditcards = parseLocalStorage('creditcards', []);
  let userInfo = parseLocalStorage('userInfo', { name: 'Sua Empresa de Eventos', cpf: 'Seu CPF/CNPJ' });
  let categories = parseLocalStorage('categories', ['Recebimento de Evento', 'Aluguel de Equipamento', 'Cachê', 'Transporte', 'Alimentação', 'Marketing', 'Impostos', 'Manutenção', 'Outras Receitas', 'Outras Despesas', 'Ajuste']);
  let receipts = parseLocalStorage('receipts', []);
  let clients = parseLocalStorage('clients', []);
  let commitments = parseLocalStorage('commitments', []);
  let eventOrders = parseLocalStorage('eventOrders', []);
  // NOVO RECURSO: Orçamentos
  let eventQuotes = parseLocalStorage('eventQuotes', []);
  let calendarCurrentDate = new Date();
  let userLogo = parseLocalStorage('userLogo', null);

  let chartInstances = {};
  const pageTitles = {
    dashboard: 'Início', transacoes: 'Transações', contas: 'Contas',
    metas: 'Metas', cartoes: 'Cartões', relatorios: 'Relatórios',
    usuario: 'Perfil', backup: 'Backup',
    recibos: 'Recibos', clientes: 'Clientes', Agenda: 'Agenda',
    documentos: 'Gerar Documentos', analise: 'Análise de Negócio', pedidos: 'Pedidos e Orçamentos'
  };
  let activeFilters = {
    search: '',
    type: 'all',
    status: 'all',
    expiredOnly: false,
    startDate: '',
    endDate: ''
  };
  // NOVO RECURSO: Filtros para pedidos/orçamentos
  let activeOrderFilters = {
    search: '',
    type: 'all',
  };

  // --- INICIALIZAÇÃO ---
  function init() {
    setupNavigation();
    setupEventListeners();
    updateUI();
  }

  // --- NAVEGAÇÃO ---
  function setupNavigation() {
    const navItems = document.querySelectorAll('.bottom-nav-item, .feature-item, .shortcut-item[data-tab-target]');
    const backButton = document.getElementById('back-button');
    navItems.forEach(item => {
      if(item.dataset.tabTarget) {
        item.addEventListener('click', () => showTab(item.dataset.tabTarget));
      }
    });
    backButton.addEventListener('click', () => showTab('dashboard'));
  }

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    const tabElement = document.getElementById(`${tabId}-content`);
    if(tabElement) tabElement.classList.add('active');
    
    if(tabId === 'documentos'){
        document.getElementById('dj-contract-template').style.display = 'none';
        document.getElementById('event-order-template').style.display = 'none';
    }

    if (tabId === 'relatorios') updateAllCharts();
    if (tabId === 'analise') updateAnaliseDashboard();
    if (tabId === 'Agenda') renderCalendar(calendarCurrentDate);
    if (tabId === 'documentos' || tabId === 'usuario') {
      document.getElementById('contract-company-name').textContent = userInfo.name || 'Sua Empresa de Eventos';
      document.getElementById('contract-company-doc').textContent = userInfo.cpf || 'Seu CPF/CNPJ';
    }
    
    updateNavState(tabId);
    updateUI();
  }
  
  function updateNavState(activeTabId) {
    document.getElementById('page-title').textContent = pageTitles[activeTabId] || 'FinancePro';
    document.getElementById('back-button').style.display = activeTabId === 'dashboard' ? 'none' : 'block';
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        const target = item.dataset.tabTarget;
        item.classList.remove('active');
        if (target === activeTabId) {
            item.classList.add('active');
        }
    });
  }

  // --- EVENT LISTENERS ---
  function setupEventListeners() {
    document.querySelectorAll('[data-action="add-new"]').forEach(btn => btn.addEventListener('click', () => openTransactionModal('new', btn.dataset.type)));
    document.querySelector('[data-action="add-new-goal"]').addEventListener('click', () => openGoalModal('new'));
    document.querySelector('[data-action="add-new-creditcard"]').addEventListener('click', () => openCreditCardModal('new'));
    
    document.getElementById('add-new-account-btn').addEventListener('click', () => openAccountModal('new'));
    document.getElementById('add-new-receipt-btn').addEventListener('click', () => openReceiptModal('new'));
    document.getElementById('add-new-client-btn').addEventListener('click', () => openClientModal('new'));
    document.getElementById('add-new-commitment-btn').addEventListener('click', () => openCommitmentModal('new'));
    document.getElementById('add-receipt-btn-aba').addEventListener('click', () => openReceiptModal('new'));
    document.getElementById('add-client-btn-aba').addEventListener('click', () => openClientModal('new'));
    document.getElementById('add-commitment-btn-aba').addEventListener('click', () => openCommitmentModal('new'));
    document.getElementById('add-new-order-btn-aba').addEventListener('click', () => openEventOrderModal('new'));
    document.getElementById('generate-dj-contract-doc-tab').addEventListener('click', () => openDJContractModal());
    document.getElementById('generate-event-order-doc-tab').addEventListener('click', () => openEventOrderModal('new'));
    // NOVO RECURSO: Adiciona eventos para orçamentos
    document.getElementById('add-new-quote-btn-aba').addEventListener('click', () => openEventQuoteModal('new'));
    document.getElementById('generate-event-quote-doc-tab').addEventListener('click', () => openEventQuoteModal('new'));
    
    // NOVO RECURSO: Botões de cadastro rápido de cliente nos modais de documentos
    document.getElementById('add-client-from-contract-btn').addEventListener('click', () => openClientModal('new', null, () => populateSelect(document.getElementById('contract-client-select'), clients, 'name', 'id')));
    document.getElementById('add-client-from-order-btn').addEventListener('click', () => openClientModal('new', null, () => populateSelect(document.getElementById('order-client-select'), clients, 'name', 'id')));
    document.getElementById('add-client-from-quote-btn').addEventListener('click', () => openClientModal('new', null, () => populateSelect(document.getElementById('quote-client-select'), clients, 'name', 'id')));

    document.getElementById('download-dj-contract').addEventListener('click', downloadDJContractAsPDF);
    document.getElementById('download-event-order').addEventListener('click', downloadEventOrderAsPDF);
    document.getElementById('download-event-quote').addEventListener('click', downloadEventQuoteAsPDF);

    document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);
    document.getElementById('account-form').addEventListener('submit', handleAccountSubmit);
    document.getElementById('goal-form-modal').addEventListener('submit', handleGoalSubmit);
    document.getElementById('creditcard-form').addEventListener('submit', handleCreditCardSubmit);
    document.getElementById('user-info-form').addEventListener('submit', handleUserInfoSubmit);
    
    document.getElementById('receipt-form').addEventListener('submit', handleReceiptSubmit);
    document.getElementById('client-form').addEventListener('submit', handleClientSubmit);
    document.getElementById('commitment-form').addEventListener('submit', handleCommitmentSubmit);
    
    document.getElementById('dj-contract-form').addEventListener('submit', handleDJContractSubmit);
    document.getElementById('event-order-form').addEventListener('submit', handleEventOrderSubmit);
    document.getElementById('add-service-btn').addEventListener('click', () => addServiceItem('order'));
    // NOVO RECURSO: Adiciona evento para o form de Orçamento
    document.getElementById('event-quote-form').addEventListener('submit', handleEventQuoteSubmit);
    document.getElementById('add-service-quote-btn').addEventListener('click', () => addServiceItem('quote'));

    document.getElementById('contract-client-select').addEventListener('change', (e) => {
        updateContractOrderSelector(e.target.value);
    });
    document.getElementById('contract-order-select').addEventListener('change', (e) => {
        populateContractFormFromOrder(e.target.value);
    });
    document.getElementById('user-logo').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('logo-preview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('logo-preview').style.display = 'none';
            document.getElementById('logo-preview').src = '#';
        }
    });
    document.getElementById('export-backup-btn').addEventListener('click', exportBackup);
    document.getElementById('import-trigger-btn').addEventListener('click', () => document.getElementById('import-backup-input').click());
    document.getElementById('import-backup-input').addEventListener('change', importBackup);
    
    document.getElementById('view-order-modal-download-btn').addEventListener('click', (e) => {
      const orderId = e.target.dataset.id;
      if (orderId) downloadExistingOrderAsPDF(parseFloat(orderId));
    });
    // NOVO RECURSO: Botões de ação no modal de visualização de orçamento
    document.getElementById('view-quote-modal-download-btn').addEventListener('click', (e) => {
        const quoteId = e.target.dataset.id;
        if (quoteId) downloadExistingQuoteAsPDF(parseFloat(quoteId));
    });
    document.getElementById('view-quote-modal-approve-btn').addEventListener('click', (e) => {
        const quoteId = e.target.dataset.id;
        if (quoteId) convertQuoteToOrder(parseFloat(quoteId));
    });
    document.getElementById('view-quote-modal-reject-btn').addEventListener('click', (e) => {
        const quoteId = e.target.dataset.id;
        if (quoteId) rejectQuote(parseFloat(quoteId));
    });

    document.getElementById('notifications-container').addEventListener('click', function(e) {
      const target = e.target.closest('.notifications-banner[data-type="pending-transactions"]');
      if (target) {
        document.getElementById('type-filter').value = 'all';
        document.getElementById('status-filter').value = 'pendente';
        document.getElementById('expired-only').checked = true;
        applyFilters();
        showTab('transacoes');
      }
    });
    document.getElementById('receita-card').addEventListener('click', () => { applyFilterAndSwitchTab({ type: 'receita' }); });
    document.getElementById('despesa-card').addEventListener('click', () => { applyFilterAndSwitchTab({ type: 'despesa' }); });
    document.getElementById('saldo-card').addEventListener('click', () => showTab('contas'));
    document.getElementById('balanco-card').addEventListener('click', () => {
      updateBalanceDetailModal();
      document.getElementById('balance-detail-modal').classList.add('active');
    });
    document.querySelectorAll('.close-button, [data-action="close-modal"]').forEach(btn => {
      btn.addEventListener('click', () => btn.closest('.modal').classList.remove('active'));
    });
    
    document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
    document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') applyFilters();
    });
    document.getElementById('search-orders-input').addEventListener('input', applyOrdersFilter);
    document.getElementById('type-orders-filter').addEventListener('change', applyOrdersFilter);
    document.getElementById('apply-orders-filter-btn').addEventListener('click', applyOrdersFilter);
    document.getElementById('clear-orders-filter-btn').addEventListener('click', clearOrdersFilter);
    
    document.getElementById('transaction-type').addEventListener('change', function() {
      const type = this.value;
      const transferTargetGroup = document.getElementById('transfer-target-type-group');
      const fromAccountGroup = document.getElementById('from-account-group');
      
      transferTargetGroup.style.display = type === 'transferencia' ? 'block' : 'none';
      fromAccountGroup.style.display = type === 'transferencia' ? 'block' : 'none';
      
      updateAccountOptions();
    });
    document.getElementById('transfer-target-type').addEventListener('change', updateAccountOptions);
    
    document.getElementById('calendar-commitments-modal').addEventListener('change', (e) => {
        if (e.target.matches('.commitment-status-select')) {
            const commitmentId = parseFloat(e.target.dataset.id);
            const newStatus = e.target.value;
            const commitment = commitments.find(c => c.id === commitmentId);
            if(commitment) {
                commitment.status = newStatus;
                saveData();
                renderCalendar(calendarCurrentDate);
                updateCommitmentsList();
                showCommitmentsForDay(commitment.date.split('T')[0]);
            }
        }
    });
    document.body.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        
        const action = target.dataset.action;
        const id = target.dataset.id ? parseFloat(target.dataset.id) : null;

        const actions = {
            'delete-transaction': () => deleteItem(transactions, id, 'Transação'),
            'edit-transaction': () => openTransactionModal('edit', null, id),
            'delete-account': () => deleteItem(accounts, id, 'Conta', () => transactions.some(t => t.toAccount == id || t.fromAccount == id), 'Existem transações associadas a esta conta.'),
            'edit-account': () => openAccountModal('edit', id),
            'adjust-balance': () => openAccountModal('adjust', id),
            'delete-goal': () => deleteItem(goals, id, 'Meta'),
            'edit-goal': () => openGoalModal('edit', id),
            'delete-creditcard': () => deleteItem(creditcards, id, 'Cartão'),
            'edit-creditcard': () => openCreditCardModal('edit', id),
            'delete-receipt': () => deleteReceiptAndTransaction(id),
            'edit-receipt': () => openReceiptModal('edit', id),
            'download-receipt-pdf': () => downloadReceiptAsPDF(id),
            'delete-client': () => deleteItem(clients, id, 'Cliente'),
            'edit-client': () => openClientModal('edit', id),
            'delete-commitment': () => deleteItem(commitments, id, 'Compromisso'),
            'edit-commitment': () => openCommitmentModal('edit', id),
            'edit-commitment-from-calendar': () => {
                document.getElementById('calendar-commitments-modal').classList.remove('active');
                openCommitmentModal('edit', id);
            },
            'delete-order': () => deleteItem(eventOrders, id, 'Pedido'),
            'edit-order': () => openEventOrderModal('edit', id),
            'view-order': () => openViewOrderModal(id),
            'remove-service': () => removeServiceItem(target),
            'edit-order-from-calendar': () => {
                document.getElementById('calendar-commitments-modal').classList.remove('active');
                openEventOrderModal('edit', id);
            },
            // NOVO RECURSO: Ações de Orçamentos
            'delete-quote': () => deleteItem(eventQuotes, id, 'Orçamento'),
            'edit-quote': () => openEventQuoteModal('edit', id),
            'view-quote': () => openViewQuoteModal(id),
            'approve-quote': () => convertQuoteToOrder(id),
        };
        if(actions[action]) actions[action]();
    });
  }

  function applyFilterAndSwitchTab(filters) {
    clearFilters();
    if(filters.type) document.getElementById('type-filter').value = filters.type;
    applyFilters();
    showTab('transacoes');
  }
  
  function applyFilters() {
    activeFilters = {
      search: document.getElementById('search-input').value.toLowerCase(),
      type: document.getElementById('type-filter').value,
      status: document.getElementById('status-filter').value,
      expiredOnly: document.getElementById('expired-only').checked,
      startDate: document.getElementById('start-date-filter').value,
      endDate: document.getElementById('end-date-filter').value
    };
    updateTransactionsTable();
  }
  
  function clearFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('type-filter').value = 'all';
    document.getElementById('status-filter').value = 'all';
    document.getElementById('expired-only').checked = false;
    document.getElementById('start-date-filter').value = '';
    document.getElementById('end-date-filter').value = '';
    
    activeFilters = { search: '', type: 'all', status: 'all', expiredOnly: false, startDate: '', endDate: '' };
    updateTransactionsTable();
  }

  // NOVO RECURSO: Funções para filtros de pedidos/orçamentos
  function applyOrdersFilter() {
    activeOrderFilters.search = document.getElementById('search-orders-input').value.toLowerCase();
    activeOrderFilters.type = document.getElementById('type-orders-filter').value;
    updateOrdersList();
  }
  
  function clearOrdersFilter() {
    document.getElementById('search-orders-input').value = '';
    document.getElementById('type-orders-filter').value = 'all';
    activeOrderFilters.search = '';
    activeOrderFilters.type = 'all';
    updateOrdersList();
  }

  function parseLocalStorage(key, def) { 
    try { 
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : def; 
    } catch { 
      return def;
    } 
  }
  
  function saveData() { 
    try {
        localStorage.setItem('accounts', JSON.stringify(accounts));
        localStorage.setItem('transactions', JSON.stringify(transactions));
        localStorage.setItem('goals', JSON.stringify(goals));
        localStorage.setItem('creditcards', JSON.stringify(creditcards));
        localStorage.setItem('userInfo', JSON.stringify(userInfo));
        localStorage.setItem('categories', JSON.stringify(categories));
        localStorage.setItem('receipts', JSON.stringify(receipts));
        localStorage.setItem('clients', JSON.stringify(clients));
        localStorage.setItem('commitments', JSON.stringify(commitments));
        localStorage.setItem('eventOrders', JSON.stringify(eventOrders));
        // NOVO RECURSO: Orçamentos
        localStorage.setItem('eventQuotes', JSON.stringify(eventQuotes));
        localStorage.setItem('userLogo', JSON.stringify(userLogo));
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
            alert('Erro: Espaço de armazenamento local cheio. Não foi possível salvar os dados. Tente usar uma imagem de logo menor ou exportar um backup e limpar os dados.');
        } else {
            alert('Ocorreu um erro inesperado ao salvar os dados.');
            console.error(e);
        }
    }
  }
  
  function deleteItem(array, id, name, condition, message) {
    if (condition && condition()) { alert(message); return; }
    if (confirm(`Tem certeza que deseja excluir este(a) ${name}?`)) {
        let index = array.findIndex(item => item.id === id);
        if (index > -1) array.splice(index, 1);
        saveData();
        updateUI();
    }
  }

  function deleteReceiptAndTransaction(receiptId) {
    if (confirm(`Tem certeza que deseja excluir este Recibo? A transação financeira associada (se houver) também será excluída.`)) {
        const linkedTransactionIndex = transactions.findIndex(t => t.linkedReceiptId === receiptId);
        if (linkedTransactionIndex > -1) {
            transactions.splice(linkedTransactionIndex, 1);
        }

        const receiptIndex = receipts.findIndex(r => r.id === receiptId);
        if (receiptIndex > -1) {
            receipts.splice(receiptIndex, 1);
        }

        saveData();
        updateUI();
    }
  }
  
  function handleTransactionSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-transaction-id').value;
    const type = document.getElementById('transaction-type').value;
    const amount = parseFloat(document.getElementById('transaction-amount').value);

    const data = {
        type: type,
        amount: amount,
        date: document.getElementById('transaction-date').value,
        description: document.getElementById('transaction-description').value,
        category: document.getElementById('transaction-category').value,
        status: document.getElementById('transaction-status').checked ? 'confirmada' : 'pendente',
        toAccount: document.getElementById('to-account').value,
        fromAccount: document.getElementById('from-account').value
    };
    if (type === 'transferencia' && document.getElementById('transfer-target-type').value === 'goal') {
      data.toAccount = `goal_${data.toAccount}`;
    }

    if (id) {
        let index = transactions.findIndex(t => t.id == id);
        if(transactions[index].linkedReceiptId){
            alert("Esta é uma transação automática de um recibo. Para alterá-la, edite o recibo correspondente.");
            return;
        }
        transactions[index] = { ...transactions[index], ...data };
    } else {
        transactions.push({ ...data, id: Date.now(), createdAt: new Date().toISOString() });
    }
    
    saveData(); 
    updateUI();
    document.getElementById('transaction-modal').classList.remove('active');
  }

  function handleAccountSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const id = form.querySelector('#edit-account-id').value;
    const accountIdForAdjustment = form.dataset.accountId;
    if (id) { // Modo Edição
        let acc = accounts.find(a => a.id === parseFloat(id));
        if (acc) {
            acc.name = form.querySelector('#account-name').value;
            acc.type = form.querySelector('#account-type').value;
        }
    } else if (accountIdForAdjustment) { // Modo Ajuste de Saldo
        const newBalance = parseFloat(form.querySelector('#account-balance').value);
        let acc = accounts.find(a => a.id === parseFloat(accountIdForAdjustment));
        if (acc && !isNaN(newBalance)) {
            recalculateAllBalances();
            const currentCalculatedBalance = accounts.find(a => a.id === parseFloat(accountIdForAdjustment)).balance;
            const adjustment = newBalance - currentCalculatedBalance;
            acc.initialBalance = (acc.initialBalance || 0) + adjustment;

            if (adjustment !== 0) {
                transactions.push({
                    id: Date.now(),
                    type: adjustment > 0 ? 'receita' : 'despesa',
                    amount: Math.abs(adjustment),
                    date: new Date().toISOString().split('T')[0],
                    description: 'Ajuste de Saldo',
                    category: 'Ajuste',
                    status: 'confirmada',
                    toAccount: acc.id,
                    createdAt: new Date().toISOString()
                });
            }
        }
    } else { // Modo Nova Conta
        const initialBalance = parseFloat(form.querySelector('#account-balance').value) || 0;
        const newAccount = {
            id: Date.now(),
            name: form.querySelector('#account-name').value,
            type: form.querySelector('#account-type').value,
            initialBalance: initialBalance,
            balance: initialBalance,
        };
        accounts.push(newAccount);
    }
    saveData(); 
    updateUI();
    form.closest('.modal').classList.remove('active');
  }
  
  function handleGoalSubmit(e){
    e.preventDefault();
    const id = document.getElementById('edit-goal-id').value;
    const data = {
      name: document.getElementById('modal-goal-name').value,
      targetAmount: parseFloat(document.getElementById('modal-goal-amount').value),
      targetDate: document.getElementById('modal-goal-date').value
    };
    if (id) {
      const index = goals.findIndex(g => g.id === parseFloat(id));
      if (index > -1) {
        goals[index] = { ...goals[index], ...data };
      }
    } else {
      goals.push({ ...data, id: Date.now(), currentAmount: 0 });
    }
    saveData(); 
    updateUI();
    document.getElementById('goal-modal').classList.remove('active');
  }

  function handleCreditCardSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-creditcard-id').value;
    const data = {
      name: document.getElementById('creditcard-name').value,
      limit: parseFloat(document.getElementById('creditcard-limit').value),
      closingDay: parseInt(document.getElementById('creditcard-closing-day').value),
      dueDay: parseInt(document.getElementById('creditcard-due-day').value)
    };
    if (id) {
      const index = creditcards.findIndex(c => c.id === parseFloat(id));
      if (index > -1) {
        creditcards[index] = { ...creditcards[index], ...data };
      }
    } else {
      creditcards.push({ ...data, id: Date.now() });
    }
    saveData(); 
    updateCreditCardsTable();
    document.getElementById('creditcard-modal').classList.remove('active');
  }
  
  async function handleUserInfoSubmit(e) {
    e.preventDefault();
    userInfo.name = document.getElementById('user-name').value;
    userInfo.cpf = document.getElementById('user-cpf').value;

    const logoFile = document.getElementById('user-logo').files[0];
    const msgEl = document.getElementById('user-info-message');
    const saveAndNotify = (message) => {
        saveData(); 
        msgEl.textContent = message;
        msgEl.style.color = 'var(--success)';
        setTimeout(() => { msgEl.textContent = ''; }, 3000);
        updateUserInfoForm(); 
        document.getElementById('contract-company-name').textContent = userInfo.name || 'Sua Empresa de Eventos';
        document.getElementById('contract-company-doc').textContent = userInfo.cpf || 'Seu CPF/CNPJ';
    };

    if (logoFile) {
        const reader = new FileReader();
        reader.onload = async function(event) {
            try {
                const originalBase64 = event.target.result;
                const compressedBase64 = await compressImage(originalBase64);
                userLogo = compressedBase64;
                saveAndNotify('Informações e logo salvas com sucesso!');
            } catch (error) {
                console.error("Erro ao comprimir a imagem:", error);
                msgEl.textContent = 'Erro ao processar a imagem.';
                msgEl.style.color = 'var(--danger)';
            }
        };
        reader.onerror = function() {
            msgEl.textContent = 'Erro ao carregar o arquivo de imagem.';
            msgEl.style.color = 'var(--danger)';
        }
        reader.readAsDataURL(logoFile);
    } else {
        saveAndNotify('Informações salvas com sucesso!');
    }
  }
  
  function handleReceiptSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-receipt-id').value;
    const receiptData = {
      clientId: parseFloat(document.getElementById('receipt-client').value),
      orderId: document.getElementById('receipt-order').value ? parseFloat(document.getElementById('receipt-order').value) : null,
      destinationAccountId: parseFloat(document.getElementById('receipt-account-destination').value),
      amount: parseFloat(document.getElementById('receipt-amount').value),
      description: document.getElementById('receipt-description').value,
      date: document.getElementById('receipt-date').value,
      status: document.getElementById('receipt-status').value
    };
    let receiptId;

    if (id) {
      const oldTxIndex = transactions.findIndex(t => t.linkedReceiptId === parseFloat(id));
      if (oldTxIndex > -1) {
        transactions.splice(oldTxIndex, 1);
      }
    }

    if (id) {
      receiptId = parseFloat(id);
      const index = receipts.findIndex(r => r.id === receiptId);
      if (index > -1) {
        receipts[index] = { ...receipts[index], ...receiptData };
      }
    } else {
      receiptId = Date.now();
      receipts.push({ ...receiptData, id: receiptId, createdAt: new Date().toISOString() });
    }

    if (receiptData.status === 'pago') {
      const client = clients.find(c => c.id === receiptData.clientId);
      let txDescription = `Pagamento recebido: ${receiptData.description}`;
      if (receiptData.orderId) {
          const order = eventOrders.find(o => o.id === receiptData.orderId);
          if (order) {
              txDescription = `Pagamento do Pedido ${order.orderNumber} (${client?.name})`;
          }
      }

      const newTransaction = {
        id: Date.now() + 1,
        linkedReceiptId: receiptId,
        type: 'receita',
        amount: receiptData.amount,
        date: receiptData.date,
        description: txDescription,
        category: 'Recebimento de Evento',
        status: 'confirmada',
        toAccount: receiptData.destinationAccountId
      };
      transactions.push(newTransaction);
    }
    
    saveData(); 
    updateUI();
    document.getElementById('receipt-modal').classList.remove('active');
  }

  function handleClientSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-client-id').value;
    const data = {
      name: document.getElementById('client-name').value,
      email: document.getElementById('client-email').value,
      phone: document.getElementById('client-phone').value,
      document: document.getElementById('client-document').value,
      birthday: document.getElementById('client-birthday').value,
      address: document.getElementById('client-address').value
    };
    let clientWasCreated = false;
    if (id) {
      const index = clients.findIndex(c => c.id === parseFloat(id));
      if (index > -1) {
        clients[index] = { ...clients[index], ...data };
      }
    } else {
      const newClient = { ...data, id: Date.now() };
      clients.push(newClient);
      clientWasCreated = true;
    }
    saveData(); 
    updateClientsList();
    document.getElementById('client-modal').classList.remove('active');
    // NOVO - Callback para atualizar os selects após o cadastro
    const callback = e.target.dataset.callback;
    if (callback) {
      window[callback](clients[clients.length-1].id);
    }
  }
  
  // NOVO - Função para popular o select de clientes e selecionar um novo
  function populateClientsAndSelect(targetSelect, callback) {
    populateSelect(targetSelect, clients, 'name', 'id');
    if (callback) callback();
  }

  function handleCommitmentSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-commitment-id').value;
    const data = {
      title: document.getElementById('commitment-title').value,
      clientId: parseFloat(document.getElementById('commitment-client').value) || null,
      date: document.getElementById('commitment-date').value,
      location: document.getElementById('commitment-location').value,
      description: document.getElementById('commitment-description').value,
      status: document.getElementById('commitment-status').value
    };
    if (id) {
      const index = commitments.findIndex(c => c.id === parseFloat(id));
      if (index > -1) {
        commitments[index] = { ...commitments[index], ...data };
      }
    } else {
      commitments.push({ ...data, id: Date.now() });
    }
    saveData(); 
    updateCommitmentsList();
    renderCalendar(calendarCurrentDate);
    document.getElementById('commitment-modal').classList.remove('active');
    showTab('Agenda');
  }
  
  function handleDJContractSubmit(e) {
    e.preventDefault();
    const clientId = document.getElementById('contract-client-select').value;
    const client = clients.find(c => c.id === parseFloat(clientId));
    if (!client) {
      alert('Selecione um cliente válido');
      return;
    }
    
    document.getElementById('contract-client-name').textContent = client.name;
    document.getElementById('contract-client-doc').textContent = client.document || 'Não informado';
    document.getElementById('contract-client-address').textContent = client.address || 'Não informado';
    document.getElementById('contract-event-location').textContent = document.getElementById('contract-event-location-input').value;
    document.getElementById('contract-event-date').textContent = formatDate(document.getElementById('contract-event-date-input').value);
    document.getElementById('contract-event-start').textContent = document.getElementById('contract-event-start-input').value;
    document.getElementById('contract-event-end').textContent = document.getElementById('contract-event-end-input').value;
    const totalValue = parseFloat(document.getElementById('contract-total-value-input').value);
    document.getElementById('contract-total-value').textContent = formatCurrency(totalValue);
    document.getElementById('contract-total-value-extenso').textContent = numberToWords(totalValue);
    document.getElementById('contract-payment-1').textContent = document.getElementById('contract-payment-1-input').value;
    document.getElementById('contract-payment-2').textContent = document.getElementById('contract-payment-2-input').value;
    document.getElementById('contract-payment-3').textContent = document.getElementById('contract-payment-3-input').value;
    document.getElementById('contract-legal-place').textContent = document.getElementById('contract-legal-place-input').value;
    
    showTab('documentos');
    document.getElementById('dj-contract-template').style.display = 'block';
    document.getElementById('event-order-template').style.display = 'none';
    document.getElementById('event-quote-template').style.display = 'none'; // NOVO
    document.getElementById('dj-contract-modal').classList.remove('active');
  }
  
  function handleEventOrderSubmit(e) {
    e.preventDefault();
    const modal = document.getElementById('event-order-modal');
    const id = document.getElementById('edit-order-id').value;
    const orderServices = [];
    let totalValue = 0;
    document.querySelectorAll('#order-services-container .order-service-item').forEach(item => {
        const desc = item.querySelector('.order-service-desc').value;
        const value = parseFloat(item.querySelector('.order-service-value').value) || 0;
        if (desc && value > 0) {
            orderServices.push({ description: desc, value: value });
            totalValue += value;
        }
    });
    const orderData = {
        clientId: parseFloat(document.getElementById('order-client-select').value),
        eventType: document.getElementById('order-event-type-input').value,
        eventDate: document.getElementById('order-event-date-input').value,
        eventTime: document.getElementById('order-event-time-input').value,
        eventLocation: document.getElementById('order-event-location-input').value,
        eventGuests: document.getElementById('order-event-guests-input').value,
        services: orderServices,
        totalValue: totalValue,
        paymentTerms: document.getElementById('order-payment-terms-input').value,
        notes: document.getElementById('order-notes-input').value,
    };
    if (id) {
        const index = eventOrders.findIndex(o => o.id === parseFloat(id));
        if (index > -1) {
            eventOrders[index] = { ...eventOrders[index], ...orderData };
        }
    } else {
        const newOrder = {
            ...orderData,
            id: Date.now(),
            orderNumber: 'EV-' + Date.now().toString().slice(-6),
        };
        eventOrders.push(newOrder);

        const client = clients.find(c => c.id === newOrder.clientId);
        const newCommitment = {
            id: Date.now() + 1,
            linkedOrderId: newOrder.id,
            title: `Evento: ${newOrder.eventType} - ${client?.name || 'Cliente'}`,
            clientId: newOrder.clientId,
            date: `${newOrder.eventDate}T${newOrder.eventTime.split(' ')[0]}`,
            location: newOrder.eventLocation,
            description: `Compromisso gerado do Pedido Nº ${newOrder.orderNumber}. Valor: ${formatCurrency(newOrder.totalValue)}.`,
            status: 'agendado'
        };
        commitments.push(newCommitment);
        
        alert('Pedido criado com sucesso! Um compromisso foi agendado automaticamente.');
    }

    saveData();
    updateUI(); 
    modal.classList.remove('active');

    const activeTabId = document.querySelector('.tab-content.active')?.id.replace('-content', '');
    if (activeTabId === 'Agenda') {
      showTab('Agenda');
    } else {
      showTab('pedidos');
    }
  }

  // NOVO RECURSO: Função para submeter o formulário de orçamento
  function handleEventQuoteSubmit(e) {
    e.preventDefault();
    const modal = document.getElementById('event-quote-modal');
    const id = document.getElementById('edit-quote-id').value;
    const quoteServices = [];
    let totalValue = 0;
    document.querySelectorAll('#quote-services-container .order-service-item').forEach(item => {
        const desc = item.querySelector('.order-service-desc').value;
        const value = parseFloat(item.querySelector('.order-service-value').value) || 0;
        if (desc && value > 0) {
            quoteServices.push({ description: desc, value: value });
            totalValue += value;
        }
    });

    const quoteData = {
        clientId: parseFloat(document.getElementById('quote-client-select').value),
        eventType: document.getElementById('quote-event-type-input').value,
        eventDate: document.getElementById('quote-event-date-input').value,
        eventTime: document.getElementById('quote-event-time-input').value,
        eventLocation: document.getElementById('quote-event-location-input').value,
        services: quoteServices,
        totalValue: totalValue,
        notes: document.getElementById('quote-notes-input').value,
        validity: parseInt(document.getElementById('quote-validity-input').value) || 30,
        status: 'emitido',
    };
    if (id) {
        const index = eventQuotes.findIndex(o => o.id === parseFloat(id));
        if (index > -1) {
            eventQuotes[index] = { ...eventQuotes[index], ...quoteData };
        }
    } else {
        const newQuote = {
            ...quoteData,
            id: Date.now(),
            quoteNumber: 'OR-' + Date.now().toString().slice(-6),
            emissionDate: new Date().toISOString().split('T')[0],
        };
        eventQuotes.push(newQuote);
        alert('Orçamento criado com sucesso!');
    }

    saveData();
    updateUI();
    modal.classList.remove('active');
    showTab('pedidos');
  }

  function populateContractFormFromOrder(orderId) {
    if (!orderId) {
        document.getElementById('contract-event-location-input').value = '';
        document.getElementById('contract-event-date-input').value = '';
        document.getElementById('contract-event-start-input').value = '';
        document.getElementById('contract-total-value-input').value = '';
        return;
    }
    
    const order = eventOrders.find(o => o.id === parseFloat(orderId));
    if (!order) return;
    document.getElementById('contract-event-location-input').value = order.eventLocation;
    document.getElementById('contract-event-date-input').value = order.eventDate;
    const startTime = order.eventTime.split(' ')[0];
    document.getElementById('contract-event-start-input').value = startTime;
    document.getElementById('contract-total-value-input').value = order.totalValue;
    alert('Dados do pedido foram carregados no formulário!');
  }

  function updateContractOrderSelector(clientId) {
    const selectorGroup = document.getElementById('contract-order-selector-group');
    const orderSelect = document.getElementById('contract-order-select');
    orderSelect.innerHTML = '<option value="">-- Selecione um Pedido --</option>';
    if (!clientId) {
        selectorGroup.style.display = 'none';
        return;
    }

    const clientOrders = eventOrders.filter(o => o.clientId === parseFloat(clientId));
    if (clientOrders.length > 0) {
        clientOrders.forEach(order => {
            const optionText = `${formatDate(order.eventDate)} - ${order.eventType} (${formatCurrency(order.totalValue)})`;
            orderSelect.add(new Option(optionText, order.id));
        });
        selectorGroup.style.display = 'block';
    } else {
        selectorGroup.style.display = 'none';
    }
  }

  // NOVO RECURSO: Função para adicionar item de serviço (genérico para pedidos e orçamentos)
  function addServiceItem(type, desc = '', value = '') {
    const container = type === 'order' ? document.getElementById('order-services-container') : document.getElementById('quote-services-container');
    const newItem = document.createElement('div');
    newItem.className = 'order-service-item';
    newItem.style.display = 'flex';
    newItem.style.gap = '10px';
    newItem.style.marginBottom = '10px';
    newItem.innerHTML = `
      <input type="text" placeholder="Descrição" class="order-service-desc" style="flex: 2;" value="${desc}">
      <input type="number" placeholder="Valor" step="0.01" min="0" class="order-service-value" style="flex: 1;" value="${value}">
      <button type="button" class="btn btn-xs btn-danger" data-action="remove-service"><i class="fas fa-times"></i></button>
    `;
    container.appendChild(newItem);
  }
  
  function removeServiceItem(button) {
    button.closest('.order-service-item').remove();
  }

  function openTransactionModal(mode, type = 'receita', id = null) {
      const modal = document.getElementById('transaction-modal');
      const form = document.getElementById('transaction-form');
      form.reset();
      document.getElementById('edit-transaction-id').value = '';
      modal.querySelector('#transaction-modal-title').textContent = 'Nova Transação';
      document.getElementById('transaction-date').valueAsDate = new Date();
      document.getElementById('transaction-type').value = type;
      const isTransfer = type === 'transferencia';
      document.getElementById('transfer-target-type-group').style.display = isTransfer ? 'block' : 'none';
      document.getElementById('from-account-group').style.display = isTransfer ? 'block' : 'none';
      if (mode === 'edit' && id) {
          const t = transactions.find(t => t.id === id);
          if (t) {
              if (t.linkedReceiptId) {
                  alert("Esta é uma transação gerada por um recibo. Para alterá-la, por favor, edite o recibo correspondente na aba 'Recibos'.");
                  return;
              }
              modal.querySelector('#transaction-modal-title').textContent = 'Editar Transação';
              document.getElementById('edit-transaction-id').value = t.id;
              document.getElementById('transaction-type').value = t.type;
              document.getElementById('transaction-amount').value = t.amount;
              document.getElementById('transaction-date').value = t.date;
              document.getElementById('transaction-description').value = t.description;
              document.getElementById('transaction-category').value = t.category;
              document.getElementById('transaction-status').checked = t.status === 'confirmada';
              
              const isEditTransfer = t.type === 'transferencia';
              document.getElementById('transfer-target-type-group').style.display = isEditTransfer ? 'block' : 'none';
              document.getElementById('from-account-group').style.display = isEditTransfer ? 'block' : 'none';
              
              updateAccountOptions();
              
              if (t.fromAccount) document.getElementById('from-account').value = t.fromAccount;
              if (isEditTransfer) {
                  if (typeof t.toAccount === 'string' && t.toAccount.startsWith('goal_')) {
                    document.getElementById('transfer-target-type').value = 'goal';
                    updateAccountOptions();
                    document.getElementById('to-account').value = t.toAccount.substring(5);
                  } else {
                    document.getElementById('transfer-target-type').value = 'account';
                    document.getElementById('to-account').value = t.toAccount;
                  }
              } else {
                document.getElementById('to-account').value = t.toAccount;
              }
          }
      } else {
        updateAccountOptions();
      }
      modal.classList.add('active');
  }
  
  function updateAccountOptions() {
    const type = document.getElementById('transaction-type').value;
    const targetType = document.getElementById('transfer-target-type').value;
    const toAccountSelect = document.getElementById('to-account');
    const fromAccountSelect = document.getElementById('from-account');
    const toAccountLabel = document.querySelector('label[for="to-account"]');
    
    toAccountSelect.innerHTML = '';
    fromAccountSelect.innerHTML = '';
    
    accounts.forEach(acc => fromAccountSelect.add(new Option(acc.name, acc.id)));
    
    if (type === 'transferencia') {
      toAccountLabel.textContent = 'Conta de Destino';
      if (targetType === 'account') {
        accounts.forEach(acc => toAccountSelect.add(new Option(acc.name, acc.id)));
      } else { // goal
        toAccountLabel.textContent = 'Meta de Destino';
        goals.forEach(goal => toAccountSelect.add(new Option(goal.name, goal.id)));
      }
    } else {
      toAccountLabel.textContent = 'Conta';
      accounts.forEach(acc => toAccountSelect.add(new Option(acc.name, acc.id)));
    }
  }

  function openAccountModal(mode, id) {
    const modal = document.getElementById('account-modal');
    const form = modal.querySelector('#account-form');
    form.reset();
    form.removeAttribute('data-account-id');
    document.getElementById('edit-account-id').value = '';

    const title = modal.querySelector('#account-modal-title');
    const nameInput = form.querySelector('#account-name');
    const typeInput = form.querySelector('#account-type');
    const balanceGroup = form.querySelector('#balance-group');
    const balanceInput = form.querySelector('#account-balance');

    nameInput.parentElement.style.display = 'block';
    typeInput.parentElement.style.display = 'block';
    balanceInput.placeholder = "0.00";
    balanceGroup.style.display = 'block';
    if (mode === 'new') {
        title.textContent = "Nova Conta";
        balanceInput.previousElementSibling.textContent = "Saldo Inicial (R$)";
    } else if (mode === 'edit') {
        const acc = accounts.find(a => a.id === id);
        if (!acc) return;
        title.textContent = "Editar Conta";
        document.getElementById('edit-account-id').value = acc.id;
        nameInput.value = acc.name;
        typeInput.value = acc.type;
        balanceGroup.style.display = 'none';
    } else if (mode === 'adjust') {
        const acc = accounts.find(a => a.id === id);
        if (!acc) return;
        title.textContent = `Ajustar Saldo de ${acc.name}`;
        nameInput.parentElement.style.display = 'none';
        typeInput.parentElement.style.display = 'none';
        balanceInput.previousElementSibling.textContent = "Novo Saldo (R$)";
        balanceInput.value = acc.balance.toFixed(2);
        balanceInput.placeholder = acc.balance.toFixed(2);
        form.dataset.accountId = id;
    }
    modal.classList.add('active');
  }

  function openGoalModal(mode, id = null) {
    const modal = document.getElementById('goal-modal');
    const form = modal.querySelector('#goal-form-modal');
    form.reset();
    modal.querySelector('#edit-goal-id').value = '';
    modal.querySelector('#goal-modal-title').textContent = 'Nova Meta';

    if (mode === 'edit' && id) {
      const goal = goals.find(g => g.id === id);
      if (goal) {
        modal.querySelector('#goal-modal-title').textContent = 'Editar Meta';
        modal.querySelector('#edit-goal-id').value = goal.id;
        modal.querySelector('#modal-goal-name').value = goal.name;
        modal.querySelector('#modal-goal-amount').value = goal.targetAmount;
        modal.querySelector('#modal-goal-date').value = goal.targetDate;
      }
    }
    modal.classList.add('active');
  }

  function openCreditCardModal(mode, id = null) {
    const modal = document.getElementById('creditcard-modal');
    const form = modal.querySelector('#creditcard-form');
    form.reset();
    modal.querySelector('#edit-creditcard-id').value = '';
    modal.querySelector('#creditcard-modal-title').textContent = 'Novo Cartão';

    if (mode === 'edit' && id) {
      const card = creditcards.find(c => c.id === id);
      if (card) {
        modal.querySelector('#creditcard-modal-title').textContent = 'Editar Cartão';
        modal.querySelector('#edit-creditcard-id').value = card.id;
        modal.querySelector('#creditcard-name').value = card.name;
        modal.querySelector('#creditcard-limit').value = card.limit;
        modal.querySelector('#creditcard-closing-day').value = card.closingDay;
        modal.querySelector('#creditcard-due-day').value = card.dueDay;
      }
    }
    modal.classList.add('active');
  }
  
  function openReceiptModal(mode, id = null) {
    const modal = document.getElementById('receipt-modal');
    const form = modal.querySelector('#receipt-form');
    form.reset();
    modal.querySelector('#edit-receipt-id').value = '';
    modal.querySelector('#receipt-modal-title').textContent = 'Novo Recibo';
    
    const clientSelect = modal.querySelector('#receipt-client');
    clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
    clients.forEach(client => clientSelect.add(new Option(client.name, client.id)));

    const accountSelect = modal.querySelector('#receipt-account-destination');
    accountSelect.innerHTML = '<option value="">Selecione uma conta</option>';
    accounts.forEach(acc => accountSelect.add(new Option(acc.name, acc.id)));

    clientSelect.removeEventListener('change', updateReceiptOrderSelector);
    clientSelect.addEventListener('change', updateReceiptOrderSelector);
    modal.querySelector('#receipt-order').removeEventListener('change', handleReceiptOrderChange);
    modal.querySelector('#receipt-order').addEventListener('change', handleReceiptOrderChange);

    if (mode === 'edit' && id) {
      const receipt = receipts.find(r => r.id === id);
      if (receipt) {
        modal.querySelector('#receipt-modal-title').textContent = 'Editar Recibo';
        modal.querySelector('#edit-receipt-id').value = receipt.id;
        modal.querySelector('#receipt-client').value = receipt.clientId;
        updateReceiptOrderSelector({ target: { value: receipt.clientId } }, () => {
            if (receipt.orderId) {
                modal.querySelector('#receipt-order').value = receipt.orderId;
            }
        });
        modal.querySelector('#receipt-account-destination').value = receipt.destinationAccountId;
        modal.querySelector('#receipt-amount').value = receipt.amount;
        modal.querySelector('#receipt-description').value = receipt.description;
        modal.querySelector('#receipt-date').value = receipt.date;
        modal.querySelector('#receipt-status').value = receipt.status;
      }
    } else {
      modal.querySelector('#receipt-date').valueAsDate = new Date();
    }
    modal.classList.add('active');
  }

  function updateReceiptOrderSelector(event, callback) {
      const clientId = event.target.value;
      const orderGroup = document.getElementById('receipt-order-group');
      const orderSelect = document.getElementById('receipt-order');
      orderSelect.innerHTML = '<option value="">Nenhum (avulso)</option>';
      if (!clientId) {
          orderGroup.style.display = 'none';
          if(callback) callback();
          return;
      }

      const clientOrders = eventOrders.filter(o => o.clientId === parseFloat(clientId));
      if (clientOrders.length > 0) {
          clientOrders.forEach(order => {
              const optionText = `Pedido ${order.orderNumber} - ${order.eventType}`;
              orderSelect.add(new Option(optionText, order.id));
          });
          orderGroup.style.display = 'block';
      } else {
          orderGroup.style.display = 'none';
      }

      if (callback) callback();
      
      handleReceiptOrderChange({ target: orderSelect });
  }

  function handleReceiptOrderChange(event) {
    const orderId = event.target.value;
    const descriptionTextarea = document.getElementById('receipt-description');
    const amountInput = document.getElementById('receipt-amount');

    if (!orderId) {
        descriptionTextarea.value = '';
        return;
    }

    const order = eventOrders.find(o => o.id === parseFloat(orderId));
    if (order) {
        const servicesDescription = order.services
            .map(s => `- ${s.description} (${formatCurrency(s.value)})`)
            .join('\n');
        
        descriptionTextarea.value = `Referente aos serviços contratados no Pedido Nº ${order.orderNumber}:\n${servicesDescription}`;
        
        amountInput.value = order.totalValue.toFixed(2);
    }
  }
  
  function openClientModal(mode, id = null, callback = null) {
    const modal = document.getElementById('client-modal');
    const form = modal.querySelector('#client-form');
    form.reset();
    modal.querySelector('#edit-client-id').value = '';
    form.dataset.callback = callback ? callback.name : '';
    modal.querySelector('#client-modal-title').textContent = 'Novo Cliente';
    if (mode === 'edit' && id) {
      const client = clients.find(c => c.id === id);
      if (client) {
        modal.querySelector('#client-modal-title').textContent = 'Editar Cliente';
        modal.querySelector('#edit-client-id').value = client.id;
        modal.querySelector('#client-name').value = client.name;
        modal.querySelector('#client-email').value = client.email;
        modal.querySelector('#client-phone').value = client.phone;
        modal.querySelector('#client-document').value = client.document;
        modal.querySelector('#client-birthday').value = client.birthday || '';
        modal.querySelector('#client-address').value = client.address;
      }
    }
    modal.classList.add('active');
  }
  
  function openCommitmentModal(mode, id = null, date = null) {
    const modal = document.getElementById('commitment-modal');
    const form = modal.querySelector('#commitment-form');
    form.reset();
    modal.querySelector('#edit-commitment-id').value = '';
    modal.querySelector('#commitment-modal-title').textContent = 'Novo Compromisso';
    
    const clientSelect = modal.querySelector('#commitment-client');
    clientSelect.innerHTML = '<option value="">Nenhum</option>';
    clients.forEach(client => clientSelect.add(new Option(client.name, client.id)));
    
    const dateInput = modal.querySelector('#commitment-date');

    if (mode === 'edit' && id) {
      const commitment = commitments.find(c => c.id === id);
      if (commitment) {
        modal.querySelector('#commitment-modal-title').textContent = 'Editar Compromisso';
        modal.querySelector('#edit-commitment-id').value = commitment.id;
        modal.querySelector('#commitment-title').value = commitment.title;
        modal.querySelector('#commitment-client').value = commitment.clientId || '';
        dateInput.value = commitment.date;
        modal.querySelector('#commitment-location').value = commitment.location;
        modal.querySelector('#commitment-description').value = commitment.description;
        modal.querySelector('#commitment-status').value = commitment.status;
      }
    } else {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      const defaultDate = date ? `${date}T${now.toTimeString().slice(0,5)}` : now.toISOString().slice(0, 16);
      dateInput.value = defaultDate;
    }
    modal.classList.add('active');
  }
  
  function openDJContractModal() {
    const modal = document.getElementById('dj-contract-modal');
    modal.querySelector('form').reset();
    document.getElementById('contract-order-selector-group').style.display = 'none';
    const clientSelect = modal.querySelector('#contract-client-select');
    clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
    clients.forEach(client => clientSelect.add(new Option(client.name, client.id)));
    modal.querySelector('#contract-event-date-input').valueAsDate = new Date();
    modal.querySelector('#contract-event-start-input').value = '20:00';
    modal.querySelector('#contract-event-end-input').value = '02:00';
    
    modal.classList.add('active');
  }
  
  function openEventOrderModal(mode, id = null) {
    const modal = document.getElementById('event-order-modal');
    const form = modal.querySelector('form');
    form.reset();
    document.getElementById('edit-order-id').value = '';
    
    const clientSelect = modal.querySelector('#order-client-select');
    clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
    clients.forEach(client => clientSelect.add(new Option(client.name, client.id)));
    
    const servicesContainer = document.getElementById('order-services-container');
    servicesContainer.innerHTML = '';
    if (mode === 'edit' && id) {
        const order = eventOrders.find(o => o.id === id);
        if (order) {
            modal.querySelector('#event-order-modal-title').textContent = 'Editar Pedido';
            document.getElementById('edit-order-id').value = order.id;
            clientSelect.value = order.clientId;
            modal.querySelector('#order-event-type-input').value = order.eventType;
            modal.querySelector('#order-event-date-input').value = order.eventDate;
            modal.querySelector('#order-event-time-input').value = order.eventTime;
            modal.querySelector('#order-event-location-input').value = order.eventLocation;
            modal.querySelector('#order-event-guests-input').value = order.eventGuests;
            modal.querySelector('#order-payment-terms-input').value = order.paymentTerms;
            modal.querySelector('#order-notes-input').value = order.notes;
            
            order.services.forEach(service => {
                addServiceItem('order', service.description, service.value);
            });
        }
    } else {
        modal.querySelector('#event-order-modal-title').textContent = 'Gerar Pedido de Evento';
        modal.querySelector('#order-event-date-input').valueAsDate = new Date();
        addServiceItem('order');
    }
    
    modal.classList.add('active');
  }

  // NOVO RECURSO: Função para abrir o modal de orçamento
  function openEventQuoteModal(mode, id = null, quoteData = null) {
    const modal = document.getElementById('event-quote-modal');
    const form = modal.querySelector('form');
    form.reset();
    document.getElementById('edit-quote-id').value = '';

    const clientSelect = modal.querySelector('#quote-client-select');
    clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
    clients.forEach(client => clientSelect.add(new Option(client.name, client.id)));

    const servicesContainer = document.getElementById('quote-services-container');
    servicesContainer.innerHTML = '';

    if (mode === 'edit' && id) {
      const quote = eventQuotes.find(q => q.id === id);
      if (quote) {
        modal.querySelector('#event-quote-modal-title').textContent = 'Editar Orçamento';
        document.getElementById('edit-quote-id').value = quote.id;
        clientSelect.value = quote.clientId;
        modal.querySelector('#quote-event-type-input').value = quote.eventType;
        modal.querySelector('#quote-event-date-input').value = quote.eventDate;
        modal.querySelector('#quote-event-time-input').value = quote.eventTime;
        modal.querySelector('#quote-event-location-input').value = quote.eventLocation;
        modal.querySelector('#quote-notes-input').value = quote.notes;
        modal.querySelector('#quote-validity-input').value = quote.validity;
        
        quote.services.forEach(service => {
          addServiceItem('quote', service.description, service.value);
        });
      }
    } else if (quoteData) { // Para conversão de pedido para orçamento
      modal.querySelector('#event-quote-modal-title').textContent = 'Converter para Orçamento';
      clientSelect.value = quoteData.clientId;
      modal.querySelector('#quote-event-type-input').value = quoteData.eventType;
      modal.querySelector('#quote-event-date-input').value = quoteData.eventDate;
      modal.querySelector('#quote-event-time-input').value = quoteData.eventTime;
      modal.querySelector('#quote-event-location-input').value = quoteData.eventLocation;
      modal.querySelector('#quote-notes-input').value = quoteData.notes;
      quoteData.services.forEach(service => {
        addServiceItem('quote', service.description, service.value);
      });
    } else {
      modal.querySelector('#event-quote-modal-title').textContent = 'Novo Orçamento';
      modal.querySelector('#quote-event-date-input').valueAsDate = new Date();
      addServiceItem('quote');
    }
    
    modal.classList.add('active');
  }
  
  function openViewOrderModal(orderId) {
    const order = eventOrders.find(o => o.id === orderId);
    if (!order) return;

    const client = clients.find(c => c.id === order.clientId) || { name: 'N/A', document: 'N/A', phone: 'N/A', email: 'N/A' };
    
    const modal = document.getElementById('view-order-modal');
    const body = document.getElementById('view-order-modal-body');
    let servicesHtml = order.services.map(s => `<p>${s.description}: <strong>${formatCurrency(s.value)}</strong></p>`).join('');

    body.innerHTML = `
      <div class="detail-group">
        <h4><i class="fas fa-file-invoice"></i> Detalhes do Pedido</h4>
        <p><strong>Número:</strong> ${order.orderNumber}</p>
        <p><strong>Valor Total:</strong> ${formatCurrency(order.totalValue)}</p>
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-user"></i> Dados do Cliente</h4>
        <p><strong>Nome:</strong> ${client.name}</p>
        <p><strong>Documento:</strong> ${client.document || 'N/A'}</p>
        <p><strong>Contato:</strong> ${client.phone || 'N/A'} | ${client.email || 'N/A'}</p>
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-calendar-check"></i> Detalhes do Evento</h4>
        <p><strong>Tipo:</strong> ${order.eventType}</p>
        <p><strong>Data:</strong> ${formatDate(order.eventDate)}</p>
        <p><strong>Horário:</strong> ${order.eventTime}</p>
        <p><strong>Local:</strong> ${order.eventLocation}</p>
        <p><strong>Convidados:</strong> ${order.eventGuests}</p>
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-concierge-bell"></i> Serviços Contratados</h4>
        ${servicesHtml}
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-money-check-alt"></i> Condições de Pagamento</h4>
        <p>${order.paymentTerms.replace(/\n/g, '<br>')}</p>
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-info-circle"></i> Observações</h4>
        <p>${order.notes.replace(/\n/g, '<br>') || 'Nenhuma.'}</p>
      </div>
    `;
    const relatedReceipts = receipts.filter(r => r.orderId === orderId && r.status === 'pago');
    const totalPaid = relatedReceipts.reduce((sum, r) => sum + r.amount, 0);
    const balanceDue = order.totalValue - totalPaid;
    let financialDetailsHtml = `
      <div class="detail-group" style="background-color: #f8f9fa; border-left: 4px solid var(--primary-light); padding: 15px; border-radius: 8px;">
        <h4 style="color: var(--primary-light);"><i class="fas fa-dollar-sign"></i> Detalhes Financeiros (Uso Interno)</h4>
    `;
    if (relatedReceipts.length > 0) {
        financialDetailsHtml += '<h5>Histórico de Pagamentos:</h5><ul>';
        relatedReceipts.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(r => {
            financialDetailsHtml += `<li>${formatDate(r.date)}: ${formatCurrency(r.amount)} (Recibo #${r.id.toString().slice(-4)})</li>`;
        });
        financialDetailsHtml += '</ul>';
    } else {
        financialDetailsHtml += '<p>Nenhum pagamento registrado para este pedido.</p>';
    }

    financialDetailsHtml += `
        <p style="margin-top: 10px;"><strong>Total Pago:</strong> ${formatCurrency(totalPaid)}</p>
        <p><strong>Saldo Devedor:</strong> <strong style="color: var(--danger);">${formatCurrency(balanceDue)}</strong></p>
      </div>
    `;
    body.innerHTML += financialDetailsHtml;
    
    document.getElementById('view-order-modal-download-btn').dataset.id = orderId;
    modal.classList.add('active');
  }

  // NOVO RECURSO: Função para abrir o modal de visualização de orçamento
  function openViewQuoteModal(quoteId) {
    const quote = eventQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    
    const client = clients.find(c => c.id === quote.clientId) || { name: 'N/A', phone: 'N/A', email: 'N/A' };
    
    const modal = document.getElementById('view-quote-modal');
    const body = document.getElementById('view-quote-modal-body');
    const totalValue = quote.services.reduce((sum, s) => sum + s.value, 0);
    let servicesHtml = quote.services.map(s => `<p>${s.description}: <strong>${formatCurrency(s.value)}</strong></p>`).join('');

    body.innerHTML = `
      <div class="detail-group">
        <h4><i class="fas fa-file-alt"></i> Detalhes do Orçamento</h4>
        <p><strong>Número:</strong> ${quote.quoteNumber}</p>
        <p><strong>Data de Emissão:</strong> ${formatDate(quote.emissionDate)}</p>
        <p><strong>Validade:</strong> ${quote.validity} dias</p>
        <p><strong>Valor Total:</strong> ${formatCurrency(totalValue)}</p>
        <p><strong>Status:</strong> <span class="quote-status ${quote.status}-orcamento">${quote.status.charAt(0).toUpperCase() + quote.status.slice(1)}</span></p>
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-user"></i> Dados do Cliente</h4>
        <p><strong>Nome:</strong> ${client.name}</p>
        <p><strong>Contato:</strong> ${client.phone || 'N/A'} | ${client.email || 'N/A'}</p>
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-calendar-check"></i> Detalhes do Evento</h4>
        <p><strong>Tipo:</strong> ${quote.eventType}</p>
        <p><strong>Data:</strong> ${formatDate(quote.eventDate)}</p>
        <p><strong>Horário:</strong> ${quote.eventTime}</p>
        <p><strong>Local:</strong> ${quote.eventLocation}</p>
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-concierge-bell"></i> Serviços Ofertados</h4>
        ${servicesHtml}
      </div>
      <div class="detail-group">
        <h4><i class="fas fa-info-circle"></i> Observações</h4>
        <p>${quote.notes.replace(/\n/g, '<br>') || 'Nenhuma.'}</p>
      </div>
    `;

    document.getElementById('view-quote-modal-download-btn').dataset.id = quoteId;
    document.getElementById('view-quote-modal-approve-btn').dataset.id = quoteId;
    document.getElementById('view-quote-modal-reject-btn').dataset.id = quoteId;

    if (quote.status === 'aprovado' || quote.status === 'recusado') {
        document.getElementById('view-quote-modal-approve-btn').style.display = 'none';
        document.getElementById('view-quote-modal-reject-btn').style.display = 'none';
    } else {
        document.getElementById('view-quote-modal-approve-btn').style.display = 'inline-flex';
        document.getElementById('view-quote-modal-reject-btn').style.display = 'inline-flex';
    }

    modal.classList.add('active');
  }

  // NOVO RECURSO: Função para converter orçamento para pedido
  function convertQuoteToOrder(quoteId) {
      if (!confirm("Tem certeza que deseja aprovar este orçamento e convertê-lo em um Pedido de Evento?")) return;
      
      const quoteIndex = eventQuotes.findIndex(q => q.id === quoteId);
      if (quoteIndex === -1) {
          alert('Orçamento não encontrado.');
          return;
      }
      const quote = eventQuotes[quoteIndex];
      quote.status = 'aprovado';
      
      const newOrder = {
          id: Date.now(),
          orderNumber: 'EV-' + Date.now().toString().slice(-6),
          clientId: quote.clientId,
          eventType: quote.eventType,
          eventDate: quote.eventDate,
          eventTime: quote.eventTime,
          eventLocation: quote.eventLocation,
          eventGuests: 0, // Não há convidados no orçamento, então preenche com 0
          services: quote.services,
          totalValue: quote.totalValue,
          paymentTerms: "Condições de pagamento do contrato a serem definidas", // Padrão
          notes: `Este pedido foi gerado a partir do Orçamento Nº ${quote.quoteNumber}. ` + quote.notes,
          linkedQuoteId: quoteId // Adiciona link para o orçamento original
      };
      eventOrders.push(newOrder);

      const client = clients.find(c => c.id === newOrder.clientId);
      const newCommitment = {
          id: Date.now() + 1,
          linkedOrderId: newOrder.id,
          title: `Evento: ${newOrder.eventType} - ${client?.name || 'Cliente'}`,
          clientId: newOrder.clientId,
          date: `${newOrder.eventDate}T${newOrder.eventTime.split(' ')[0]}`,
          location: newOrder.eventLocation,
          description: `Compromisso gerado do Pedido Nº ${newOrder.orderNumber}. Valor: ${formatCurrency(newOrder.totalValue)}.`,
          status: 'agendado'
      };
      commitments.push(newCommitment);
      
      saveData();
      updateUI();
      document.getElementById('view-quote-modal').classList.remove('active');
      alert(`Orçamento Nº ${quote.quoteNumber} aprovado e convertido no Pedido Nº ${newOrder.orderNumber}!`);
      showTab('pedidos');
  }

  // NOVO RECURSO: Função para rejeitar um orçamento
  function rejectQuote(quoteId) {
      if (!confirm("Tem certeza que deseja recusar este orçamento?")) return;
      const quote = eventQuotes.find(q => q.id === quoteId);
      if (quote) {
          quote.status = 'recusado';
          saveData();
          updateUI();
          document.getElementById('view-quote-modal').classList.remove('active');
          alert('Orçamento recusado com sucesso.');
          showTab('pedidos');
      }
  }


  function updateUI() {
    recalculateAllBalances();
    updateSummaryCards();
    updateNotificationsBanner();
    updateTransactionsTable();
    updateAccountsTable();
    updateGoalsList();
    updateCreditCardsTable();
    updateCategoriesList();
    updateUserInfoForm();
    updateReceiptsList();
    updateClientsList();
    updateCommitmentsList();
    updateOrdersList();
  }

  function recalculateAllBalances() {
      accounts.forEach(acc => acc.balance = acc.initialBalance || 0);
      const confirmedTxs = transactions.filter(t => t.status === 'confirmada');
      
      confirmedTxs.sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
      confirmedTxs.forEach(t => {
          const amount = t.amount;
          const toAccId = typeof t.toAccount === 'string' && t.toAccount.startsWith('goal_') ? null : parseFloat(t.toAccount);
          const fromAccId = parseFloat(t.fromAccount);

          if (t.type === 'receita') {
            const acc = accounts.find(a => a.id === toAccId);
            if (acc) acc.balance += amount;
          } else if (t.type === 'despesa') {
            const acc = accounts.find(a => a.id === toAccId);
            if (acc) acc.balance -= amount;
          } else if (t.type === 'transferencia') {
            const fromAcc = accounts.find(a => a.id === fromAccId);
            if (fromAcc) fromAcc.balance -= amount;

            const toAcc = accounts.find(a => a.id === toAccId);
            if (toAcc) toAcc.balance += amount;
          }
      });
      goals.forEach(goal => goal.currentAmount = 0);
      confirmedTxs.filter(t => t.type === 'transferencia' && typeof t.toAccount === 'string' && t.toAccount.startsWith('goal_'))
      .forEach(t => {
        const goalId = parseFloat(t.toAccount.substring(5));
        const goal = goals.find(g => g.id === goalId);
        if (goal) {
          goal.currentAmount += t.amount;
        }
      });
  }

  function updateSummaryCards() {
    const today = new Date();
    const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const prevMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const prevMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
    const confirmedTxs = transactions.filter(t => t.status === 'confirmada');
    const currentMonthTxs = confirmedTxs.filter(t => new Date(t.date + 'T00:00:00') >= currentMonthStart);
    const prevMonthTxs = confirmedTxs.filter(t => new Date(t.date + 'T00:00:00') >= prevMonthStart && new Date(t.date + 'T00:00:00') <= prevMonthEnd);
    const R_curr = currentMonthTxs.filter(t=>t.type==='receita').reduce((s,t)=>s+t.amount,0);
    const D_curr = currentMonthTxs.filter(t=>t.type==='despesa').reduce((s,t)=>s+t.amount,0);
    const R_prev = prevMonthTxs.filter(t=>t.type==='receita').reduce((s,t)=>s+t.amount,0);
    const D_prev = prevMonthTxs.filter(t=>t.type==='despesa').reduce((s,t)=>s+t.amount,0);
    const saldoTotal = accounts.reduce((s, a) => s + a.balance, 0);
    const totalOrderValue = eventOrders.reduce((sum, o) => sum + (o.totalValue || 0), 0);
    const totalPaidReceipts = receipts.filter(r => r.status === 'pago').reduce((sum, r) => sum + r.amount, 0);
    const outstandingValue = totalOrderValue - totalPaidReceipts;
    const projectedBalance = saldoTotal + (outstandingValue > 0 ? outstandingValue : 0);
    
    document.getElementById('total-receitas').textContent = formatCurrency(R_curr);
    document.getElementById('total-despesas').textContent = formatCurrency(D_curr);
    document.getElementById('saldo-total').textContent = formatCurrency(saldoTotal);
    document.getElementById('balanco-mensal').textContent = formatCurrency(R_curr - D_curr);
    
    document.getElementById('receitas-trend').innerHTML = formatPercentageChange(R_curr, R_prev);
    document.getElementById('despesas-trend').innerHTML = formatPercentageChange(D_curr, D_prev, true);
    document.getElementById('saldo-forecast').textContent = `Previsão: ${formatCurrency(projectedBalance)}`;
  }
  
  function updateNotificationsBanner() {
      const container = document.getElementById('notifications-container');
      container.innerHTML = '';
      
      const today = new Date();
      today.setHours(0,0,0,0);
      const pending = transactions.filter(t => t.status === 'pendente' && new Date(t.date + 'T00:00:00') <= today);
      if (pending.length > 0) {
          let msg = `<strong>Atenção:</strong> Você tem ${pending.length} transação(ões) pendente(s) ou vencida(s).`;
          const banner = document.createElement('div');
          banner.className = 'notifications-banner warning';
          banner.style.display = 'flex';
          banner.dataset.type = 'pending-transactions';
          banner.innerHTML = `<i class="fas fa-exclamation-triangle"></i><div>${msg}</div>`;
          container.appendChild(banner);
      }
      
      const upcomingBirthdays = [];
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      clients.forEach(client => {
          if (!client.birthday) return;
          const birthday = new Date(client.birthday + 'T00:00:00');
          birthday.setFullYear(now.getFullYear());
          
          const diff = (birthday.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
          
          if (diff >= 0 && diff <= 7) {
              upcomingBirthdays.push(client.name);
          }
      });
      if (upcomingBirthdays.length > 0) {
          let msg = `<strong>Aniversários:</strong> ${upcomingBirthdays.join(', ')} comemoram nos próximos 7 dias.`;
          const banner = document.createElement('div');
          banner.className = 'notifications-banner info';
          banner.style.display = 'flex';
          banner.innerHTML = `<i class="fas fa-birthday-cake"></i><div>${msg}</div>`;
          container.appendChild(banner);
      }
  }

  function updateTransactionsTable() {
    const list = document.getElementById('all-transactions-list');
    list.innerHTML = '';
    const today = new Date().toISOString().split('T')[0];
    
    const filteredTransactions = transactions.filter(t => {
      const descMatch = !activeFilters.search || t.description.toLowerCase().includes(activeFilters.search);
      const typeMatch = activeFilters.type === 'all' || t.type === activeFilters.type;
      const statusMatch = activeFilters.status === 'all' || t.status === activeFilters.status;
      const expiredMatch = !activeFilters.expiredOnly || (t.status === 'pendente' && t.date < today);
      
      const transactionDate = new Date(t.date + 'T00:00:00');
      const startDateMatch = !activeFilters.startDate || transactionDate >= new Date(activeFilters.startDate + 'T00:00:00');
      const endDateMatch = !activeFilters.endDate || transactionDate <= new Date(activeFilters.endDate + 'T00:00:00');

      return descMatch && typeMatch && statusMatch && expiredMatch && startDateMatch && endDateMatch;
    }).sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
    if (filteredTransactions.length === 0) {
      list.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--gray);"><i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i><p>Nenhuma transação encontrada</p></div>`;
      return;
    }
    
    filteredTransactions.forEach(t => list.appendChild(createTransactionCard(t)));
  }

  function createTransactionCard(t) {
    const card = document.createElement('div');
    card.className = `transaction-card ${t.type}`;
    const valueClass = t.type === 'despesa' ? 'negative' : 'positive';
    const statusClass = t.status === 'confirmada' ? 'confirmada' : 'pendente';
    const statusText = t.status === 'confirmada' ? 'Confirmada' : 'Pendente';
    card.innerHTML = `
      <div class="transaction-header">
        <span class="category-badge">${t.category}</span>
        <span class="status-badge ${statusClass}">${statusText}</span>
      </div>
      <div class="transaction-body">
        <span class="transaction-favorecido">${t.description} ${t.linkedReceiptId ? '<i class="fas fa-link" style="font-size: 0.8em; color: var(--gray);"></i>' : ''}</span>
        <span class="transaction-details">${formatDate(t.date)}</span>
      </div>
      <div class="transaction-footer">
        <span class="transaction-value ${valueClass}">${formatCurrency(t.amount)}</span>
        <div class="transaction-actions">
          <button class="btn btn-xs" data-action="edit-transaction" data-id="${t.id}"><i class="fas fa-edit"></i></button>
          <button class="btn btn-xs btn-danger" data-action="delete-transaction" data-id="${t.id}"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
    return card;
  }

  function updateAccountsTable() {
    const tbody = document.querySelector('#accounts-list tbody');
    tbody.innerHTML = '';
    accounts.forEach(acc => {
      tbody.innerHTML += `
        <tr>
          <td>${acc.name}<br><small style="color:var(--gray)">${acc.type}</small></td>
          <td class="${acc.balance >= 0 ? 'positive' : 'negative'}">${formatCurrency(acc.balance)}</td>
          <td style="text-align:right">
            <button class="btn btn-xs" data-action="edit-account" data-id="${acc.id}" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="btn btn-xs" data-action="adjust-balance" data-id="${acc.id}" title="Ajustar Saldo"><i class="fas fa-sliders-h"></i></button>
            <button class="btn btn-xs btn-danger" data-action="delete-account" data-id="${acc.id}" title="Excluir"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
    });
  }
  
  function updateGoalsList() {
    const container = document.getElementById('goals-list');
    container.innerHTML = '';
    if (goals.length === 0) {
        container.innerHTML = `<p style="text-align:center; color: var(--gray);">Nenhuma meta cadastrada.</p>`;
        return;
    }
    goals.forEach(goal => {
        const progress = (goal.targetAmount > 0) ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin:0;">${goal.name}</h4>
                <div>
                  <button class="btn btn-xs" data-action="edit-goal" data-id="${goal.id}"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-xs btn-danger" data-action="delete-goal" data-id="${goal.id}"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            
            <p style="margin: 5px 0; font-size: 0.9rem;">
                ${formatCurrency(goal.currentAmount)} / <strong>${formatCurrency(goal.targetAmount)}</strong>
            </p>
            <div class="progress-bar">
               <div style="width: ${progress.toFixed(2)}%;"></div>
            </div>
            <p style="margin-top: 5px; font-size: 0.8rem; color: var(--gray);">Data limite: ${formatDate(goal.targetDate)}</p>
        `;
        container.appendChild(card);
    });
  }

  function updateCreditCardsTable() {
    const tbody = document.querySelector('#creditcards-list tbody');
    tbody.innerHTML = '';
    creditcards.forEach(card => {
      tbody.innerHTML += `
        <tr>
          <td>${card.name}</td>
          <td>${formatCurrency(card.limit)}</td>
          <td>${card.closingDay}</td>
           <td>${card.dueDay}</td>
          <td style="text-align:right">
            <button class="btn btn-xs" data-action="edit-creditcard" data-id="${card.id}" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="btn btn-xs btn-danger" data-action="delete-creditcard" data-id="${card.id}" title="Excluir"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
    });
  }

  function updateCategoriesList() {
    const datalist = document.getElementById('categories-list');
    if (datalist) {
          datalist.innerHTML = categories.map(c => `<option value="${c}">`).join('');
    }
  }
  
  function updateUserInfoForm() {
    document.getElementById('user-name').value = userInfo.name || '';
    document.getElementById('user-cpf').value = userInfo.cpf || '';
    const logoPreview = document.getElementById('logo-preview');
    if (userLogo) {
        logoPreview.src = userLogo;
        logoPreview.style.display = 'block';
    } else {
        logoPreview.style.display = 'none';
        logoPreview.src = '#';
    }
  }
  
  function updateBalanceDetailModal() {
    const today = new Date();
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    const currentMonthTxs = transactions.filter(t => new Date(t.date + 'T00:00:00') >= monthStart && t.status === 'confirmada');
    const R_curr = currentMonthTxs.filter(t => t.type === 'receita').reduce((s, t) => s + t.amount, 0);
    const D_curr = currentMonthTxs.filter(t => t.type === 'despesa').reduce((s, t) => s + t.amount, 0);
    const currentBalance = R_curr - D_curr;
    const pendingTxs = transactions.filter(t => t.status === 'pendente' && new Date(t.date + 'T00:00:00') <= monthEnd);
    const R_pending = pendingTxs.filter(t => t.type === 'receita').reduce((s, t) => s + t.amount, 0);
    const D_pending = pendingTxs.filter(t => t.type === 'despesa').reduce((s, t) => s + t.amount, 0);
    const pendingNet = R_pending - D_pending;
    const saldoTotal = accounts.reduce((s, a) => s + a.balance, 0);
    const monthlyProjectedBalance = currentBalance + pendingNet;
    const finalProjectedBalance = saldoTotal + pendingNet;

    const prevMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const prevMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
    const prevMonthTxs = transactions.filter(t => new Date(t.date + 'T00:00:00') >= prevMonthStart && new Date(t.date + 'T00:00:00') <= prevMonthEnd && t.status === 'confirmada');
    const R_prev = prevMonthTxs.filter(t => t.type === 'receita').reduce((s, t) => s + t.amount, 0);
    const D_prev = prevMonthTxs.filter(t => t.type === 'despesa').reduce((s, t) => s + t.amount, 0);
    const prevBalance = R_prev - D_prev;
    const diff = currentBalance - prevBalance;
    const percent = prevBalance !== 0 ? (diff / Math.abs(prevBalance)) * 100 : 0;
    let html = `
      <div class="balance-detail-item"><h3><i class="fas fa-chart-line"></i> Balanço Atual</h3><p>Receitas: <strong>${formatCurrency(R_curr)}</strong></p><p>Despesas: <strong>${formatCurrency(D_curr)}</strong></p><p>Balanço do Mês: <strong class="${currentBalance >= 0 ? 'positive' : 'negative'}">${formatCurrency(currentBalance)}</strong></p></div>
      <div class="balance-detail-item"><h3><i class="fas fa-clock"></i> Pendências do Mês</h3><p>Receitas Pendentes: <strong>${formatCurrency(R_pending)}</strong></p><p>Despesas Pendentes: <strong>${formatCurrency(D_pending)}</strong></p></div>
      <div class="balance-detail-item"><h3><i class="fas fa-project-diagram"></i> Projeção para o Final do Mês</h3><p>Balanço Projetado do Mês: <strong class="${monthlyProjectedBalance >= 0 ? 'positive' : 'negative'}">${formatCurrency(monthlyProjectedBalance)}</strong></p><p>Saldo Total Projetado: <strong class="${finalProjectedBalance >= 0 ? 'positive' : 'negative'}">${formatCurrency(finalProjectedBalance)}</strong></p></div>
      <div class="balance-detail-item"><h3><i class="fas fa-exchange-alt"></i> Comparação com Mês Anterior</h3><p>Balanço Anterior: <strong>${formatCurrency(prevBalance)}</strong></p><p>Variação: <strong class="${diff >= 0 ? 'positive' : 'negative'}">${percent.toFixed(1)}%</strong></p></div>`;

    document.getElementById('balance-detail-content').innerHTML = html;
  }
  
  function updateReceiptsList() {
    const list = document.getElementById('receipts-list');
    list.innerHTML = '';
    
    if (receipts.length === 0) {
      list.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--gray);"><i class="fas fa-file-invoice" style="font-size: 3rem; margin-bottom: 15px;"></i><p>Nenhum recibo cadastrado</p></div>`;
      return;
    }
    
    receipts.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(receipt => {
      const client = clients.find(c => c.id === receipt.clientId) || { name: 'Cliente não encontrado' };
      const statusTexts = { emitido: 'Emitido', pago: 'Pago', cancelado: 'Cancelado' };
      
      const card = document.createElement('div');
      card.className = 'receipt-card';
      card.innerHTML = `
        <div class="transaction-header">
          <span class="category-badge">Recibo #${receipt.id.toString().slice(-4)}</span>
          <span class="status-badge ${receipt.status}">${statusTexts[receipt.status]}</span>
        </div>
        <div class="transaction-body">
          <span class="transaction-favorecido">${client.name}</span>
          <span class="transaction-details">${receipt.description}</span>
          <span class="transaction-details">${formatDate(receipt.date)}</span>
        </div>
        <div class="transaction-footer">
          <span class="transaction-value">${formatCurrency(receipt.amount)}</span>
          <div class="transaction-actions">
            <button class="btn btn-xs" data-action="download-receipt-pdf" data-id="${receipt.id}"><i class="fas fa-download"></i> PDF</button>
            <button class="btn btn-xs" data-action="edit-receipt" data-id="${receipt.id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-xs btn-danger" data-action="delete-receipt" data-id="${receipt.id}"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `;
      list.appendChild(card);
    });
  }
  
  function updateClientsList() {
    const list = document.getElementById('clients-list');
    list.innerHTML = '';
    if (clients.length === 0) {
      list.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--gray);"><i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px;"></i><p>Nenhum cliente cadastrado</p></div>`;
      return;
    }
    
    clients.sort((a,b) => a.name.localeCompare(b.name)).forEach(client => {
      const birthday = client.birthday ? formatDate(client.birthday) : 'Não informado';
      const card = document.createElement('div');
      card.className = 'client-card';
      card.innerHTML = `
        <div class="transaction-body">
          <span class="transaction-favorecido">${client.name}</span>
          <div class="transaction-details" style="display: flex; flex-direction: column; gap: 4px; margin-top: 8px;">
            ${client.email ? `<div><i class="fas fa-envelope fa-fw" style="margin-right: 5px;"></i>${client.email}</div>` : ''}
            ${client.phone ? `<div><i class="fas fa-phone fa-fw" style="margin-right: 5px;"></i>${client.phone}</div>` : ''}
            <div><i class="fas fa-birthday-cake fa-fw" style="margin-right: 5px;"></i>${birthday}</div>
          </div>
        </div>
        <div class="transaction-footer">
            <span></span>
            <div class="transaction-actions">
                <button class="btn btn-xs" data-action="edit-client" data-id="${client.id}"><i class="fas fa-edit"></i></button>
                <button class="btn btn-xs btn-danger" data-action="delete-client" data-id="${client.id}"><i class="fas fa-trash"></i></button>
            </div>
        </div>`;
      list.appendChild(card);
    });
  }
  
  function updateCommitmentsList() {
    const list = document.getElementById('commitments-list');
    list.innerHTML = '';
    const currentYear = calendarCurrentDate.getFullYear();
    const currentMonth = calendarCurrentDate.getMonth();

    const filteredCommitments = commitments.filter(c => {
        const commitmentDate = new Date(c.date);
        return commitmentDate.getFullYear() === currentYear && commitmentDate.getMonth() === currentMonth;
    });
    if (filteredCommitments.length === 0) {
      list.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--gray);"><i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i><p>Nenhum compromisso para este mês.</p></div>`;
      return;
    }
    
    filteredCommitments.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(commitment => {
      const client = commitment.clientId ? clients.find(c => c.id === commitment.clientId) : null;
      const statusTexts = { agendado: 'Agendado', confirmado: 'Confirmado', realizado: 'Realizado', cancelado: 'Cancelado' };
      const date = new Date(commitment.date);
      const formattedDate = date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
      
      const card = document.createElement('div');
      card.className = 'commitment-card';
      card.innerHTML = `
        <div class="transaction-header">
          <span class="category-badge">${formattedDate}</span>
          <span class="status-badge ${commitment.status}">${statusTexts[commitment.status]}</span>
        </div>
        <div class="transaction-body">
          <span class="transaction-favorecido">${commitment.title}</span>
          <div class="transaction-details" style="display: flex; flex-direction: column; gap: 4px; margin-top: 8px;">
            ${client ? `<div><i class="fas fa-user fa-fw" style="margin-right: 5px;"></i>${client.name}</div>` : ''}
            ${commitment.location ? `<div><i class="fas fa-map-marker-alt fa-fw" style="margin-right: 5px;"></i>${commitment.location}</div>` : ''}
          </div>
        </div>
        <div class="transaction-footer">
          <span></span>
          <div class="transaction-actions">
            <button class="btn btn-xs" data-action="edit-commitment" data-id="${commitment.id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-xs btn-danger" data-action="delete-commitment" data-id="${commitment.id}"><i class="fas fa-trash"></i></button>
          </div>
        </div>`;
      list.appendChild(card);
    });
  }

  function updateOrdersList() {
    const list = document.getElementById('orders-list');
    list.innerHTML = '';
    
    const searchTerm = activeOrderFilters.search;
    const typeFilter = activeOrderFilters.type;

    let allItems = [];
    if (typeFilter === 'all' || typeFilter === 'order') {
        allItems.push(...eventOrders.map(o => ({ ...o, type: 'order' })));
    }
    if (typeFilter === 'all' || typeFilter === 'quote') {
        allItems.push(...eventQuotes.map(q => ({ ...q, type: 'quote' })));
    }

    let filteredItems = allItems.filter(item => {
        const client = clients.find(c => c.id === item.clientId) || {};
        const clientName = (client.name || '').toLowerCase();
        const number = (item.type === 'order' ? item.orderNumber : item.quoteNumber).toLowerCase();
        return clientName.includes(searchTerm) || number.includes(searchTerm);
    });

    if (filteredItems.length === 0) {
        const message = searchTerm ? 'Nenhum item encontrado para sua busca.' : 'Nenhum pedido ou orçamento cadastrado.';
        list.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--gray);"><i class="fas fa-clipboard-check" style="font-size: 3rem; margin-bottom: 15px;"></i><p>${message}</p></div>`;
        return;
    }

    filteredItems.sort((a, b) => {
        const dateA = a.type === 'order' ? a.eventDate : a.emissionDate;
        const dateB = b.type === 'order' ? b.eventDate : b.emissionDate;
        return new Date(dateB) - new Date(dateA);
    }).forEach(item => {
        const client = clients.find(c => c.id === item.clientId) || { name: 'Cliente não encontrado' };
        
        const cardType = item.type === 'order' ? 'order-card' : 'quote-card';
        const number = item.type === 'order' ? item.orderNumber : item.quoteNumber;
        const typeLabel = item.type === 'order' ? 'Pedido' : 'Orçamento';
        const valueColor = item.type === 'order' ? 'var(--event-orange)' : 'var(--event-blue)';
        const date = item.type === 'order' ? item.eventDate : item.emissionDate;

        let statusBadge = '';
        if (item.type === 'quote') {
          const statusTexts = { 'emitido': 'Pendente', 'aprovado': 'Aprovado', 'recusado': 'Recusado' };
          statusBadge = `<span class="status-badge ${item.status}-orcamento">${statusTexts[item.status]}</span>`;
        }

        const card = document.createElement('div');
        card.className = cardType;
        card.innerHTML = `
            <div class="transaction-header">
              <span class="category-badge">${typeLabel} Nº ${number}</span>
                <span class="transaction-details">${formatDate(date)}</span>
            </div>
            <div class="transaction-body">
                <span class="transaction-favorecido">${item.eventType} - ${client.name}</span>
                <span class="transaction-details">Local: ${item.eventLocation || 'Não informado'}</span>
            </div>
            <div class="transaction-footer">
                <span class="transaction-value" style="color: ${valueColor};">${formatCurrency(item.totalValue)}</span>
                <div class="transaction-actions">
                    ${statusBadge}
                    <button class="btn btn-xs" data-action="view-${item.type}" data-id="${item.id}" title="Visualizar"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-xs" data-action="edit-${item.type}" data-id="${item.id}" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-xs btn-danger" data-action="delete-${item.type}" data-id="${item.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        list.appendChild(card);
    });
  }

  function addModernDocLayout(doc, title) {
    const pageHeight = doc.internal.pageSize.height;
    const pageWidth = doc.internal.pageSize.width;
    const primaryColor = '#6a11cb';
    const margin = 15;

    doc.setFillColor(primaryColor);
    doc.rect(0, 0, pageWidth, 35, 'F');
    if (userLogo) {
      addLogoToPdf(doc, margin, 8, 70, 20);
    }

    doc.setFontSize(10);
    doc.setTextColor('#FFFFFF');
    doc.setFont(undefined, 'bold');
    if (userInfo.name) {
      doc.text(userInfo.name, pageWidth - margin, 17, { align: 'right' });
    }
    if (userInfo.cpf) {
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        doc.text(userInfo.cpf, pageWidth - margin, 25, { align: 'right' });
    }

    doc.setDrawColor(primaryColor);
    doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
    doc.setFontSize(8);
    doc.setTextColor('#888888');
    doc.text(`Documento gerado por FinancePro em ${new Date().toLocaleDateString('pt-BR')}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
    doc.setLineWidth(1.5);
    doc.setDrawColor(primaryColor);
    doc.rect(5, 5, pageWidth - 10, pageHeight - 10, 'S');

    doc.setLineWidth(0.5);
    doc.setDrawColor('#AAAAAA');
    doc.rect(7, 7, pageWidth - 14, pageHeight - 14, 'S');
    doc.setFontSize(18);
    doc.setTextColor(primaryColor);
    doc.setFont(undefined, 'bold');
    doc.text(title, pageWidth / 2, 55, { align: 'center' });

    doc.setTextColor('#000000');
    doc.setFont(undefined, 'normal');
    doc.setDrawColor('#000000');
    return { startY: 70 };
  }

  function addLogoToPdf(doc, x, y, maxWidth, maxHeight) {
    if (userLogo) {
        try {
            const img = new Image();
            img.src = userLogo;
            const imgWidth = img.width;
            const imgHeight = img.height;

            let ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);
            doc.addImage(userLogo, 'JPEG', x, y, imgWidth * ratio, imgHeight * ratio);
        } catch(e) {
            console.error("Não foi possível adicionar a logo ao PDF.", e);
        }
    }
  }

  function downloadReceiptAsPDF(receiptId) {
    const receipt = receipts.find(r => r.id === receiptId);
    if (!receipt) return;
    const client = clients.find(c => c.id === receipt.clientId) || {};
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const primaryColor = '#6a11cb';

    let { startY } = addModernDocLayout(doc, "RECIBO DE PAGAMENTO");

    doc.setFontSize(10);
    doc.text(`Recibo Nº: ${receipt.id.toString().slice(-4)}`, 15, startY);
    doc.text(`Data de Emissão: ${formatDate(receipt.date)}`, doc.internal.pageSize.width - 15, startY, { align: 'right' });
    startY += 10;
    doc.setDrawColor('#DDDDDD');
    doc.line(15, startY - 2, doc.internal.pageSize.width - 15, startY - 2);
    
    startY += 8;
    const valueInWords = numberToWords(receipt.amount);
    const receiptBodyText = `Recebemos de ${client.name || '(Cliente não informado)'}, portador(a) do documento ${client.document || '(não informado)'}, a importância de ${formatCurrency(receipt.amount)} (${valueInWords}), referente ao seguinte serviço:`;
    
    doc.setFontSize(11);
    const splitText = doc.splitTextToSize(receiptBodyText, doc.internal.pageSize.width - 30);
    doc.text(splitText, 15, startY);
    startY += (splitText.length * 6) + 5;
    doc.autoTable({
        startY: startY,
        head: [['Descrição do Serviço', 'Valor']],
        body: [[receipt.description, formatCurrency(receipt.amount)]],
        theme: 'grid',
        headStyles: { fillColor: primaryColor, textColor: '#FFFFFF', fontStyle: 'bold' },
        footStyles: { fillColor: '#F5F5F5', textColor: '#000000', fontStyle: 'bold' },
        foot: [['TOTAL', formatCurrency(receipt.amount)]],
        margin: { left: 15, right: 15 },
    });
    
    startY = doc.lastAutoTable.finalY + 30;

    doc.text('________________________________', doc.internal.pageSize.width / 2, startY, { align: 'center' });
    startY += 7;
    doc.setFontSize(10);
    doc.text(userInfo.name, doc.internal.pageSize.width / 2, startY, { align: 'center' });
    startY += 5;
    doc.text(userInfo.cpf, doc.internal.pageSize.width / 2, startY, { align: 'center' });
    
    doc.save(`Recibo_${receipt.id}_${(client.name || 'cliente').replace(/\s/g, '_')}.pdf`);
  }
  
  function downloadDJContractAsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    const primaryColor = '#6a11cb';
    const margin = 40;
    const pageWidth = doc.internal.pageSize.width;
    const usableWidth = pageWidth - (margin * 2);
    
    const baseFontSize = 9;
    const titleFontSize = 10;
    const headingFontSize = 14;
    const lineSpacing = 11;
    
    addModernDocLayout(doc, "");
    let y = 70;

    doc.setFont(undefined, 'bold');
    doc.setFontSize(headingFontSize);
    doc.setTextColor('#333333');
    doc.text("CONTRATO DE PRESTAÇÃO DE SERVIÇOS ARTÍSTICOS DE DJ", pageWidth / 2, y, { align: 'center' });
    y += lineSpacing * 2;


    const addClause = (title, text) => {
        if (y > doc.internal.pageSize.height - 120) return;
        doc.setFont(undefined, 'bold');
        doc.setFontSize(titleFontSize);
        doc.setTextColor(primaryColor);
        doc.text(title, margin, y);
        y += lineSpacing * 1.5;

        doc.setFont(undefined, 'normal');
        doc.setFontSize(baseFontSize);
        doc.setTextColor('#333333');
        const lines = doc.splitTextToSize(text, usableWidth);
        doc.text(lines, margin, y);
        y += (lines.length * lineSpacing) + (lineSpacing / 2);
    };
    const addList = (items) => {
        doc.setFont(undefined, 'normal');
        doc.setFontSize(baseFontSize);
        doc.setTextColor('#333333');
        items.forEach(item => {
            const lines = doc.splitTextToSize(item, usableWidth - 10);
            doc.text(`•`, margin, y + (lineSpacing/2) - 3);
            doc.text(lines, margin + 10, y);
            y += (lines.length * lineSpacing);
        });
        y += (lineSpacing / 2);
    };
    
    doc.setFont(undefined, 'bold');
    doc.setFontSize(titleFontSize);
    doc.setTextColor(primaryColor);
    doc.text("Pelo presente instrumento particular, as partes:", margin, y);
    y += lineSpacing * 1.5;

    let partesText = `CONTRATANTE: ${document.getElementById('contract-client-name').textContent}, CPF/CNPJ nº ${document.getElementById('contract-client-doc').textContent}, com endereço em ${document.getElementById('contract-client-address').textContent}.`;
    addClause('DAS PARTES', partesText);
    partesText = `CONTRATADO: ${document.getElementById('contract-company-name').textContent}, CPF/CNPJ nº ${document.getElementById('contract-company-doc').textContent}, doravante denominado DJ.`;
    const lines = doc.splitTextToSize(partesText, usableWidth);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(baseFontSize);
    doc.setTextColor('#333333');
    doc.text(lines, margin, y);
    y += (lines.length * lineSpacing) + lineSpacing;
    addClause('CLÁUSULA 1ª - DO OBJETO', `Prestação de serviços de Disc Jockey (DJ) para o evento em ${document.getElementById('contract-event-location').textContent}, no dia ${document.getElementById('contract-event-date').textContent}, das ${document.getElementById('contract-event-start').textContent} às ${document.getElementById('contract-event-end').textContent}.`);
    addClause('CLÁUSULA 2ª - OBRIGAÇÕES DO CONTRATADO', 'O DJ se compromete a:');
    addList([ 'Fornecer equipamento de som e iluminação necessários e compatíveis com o porte do evento;', 'Comparecer ao local com antecedência para montagem e testes;', 'Executar o repertório musical alinhado previamente com o CONTRATANTE;', 'Manter conduta profissional e zelar pela qualidade técnica da apresentação.']);
    addClause('CLÁUSULA 3ª - OBRIGAÇÕES DO CONTRATANTE', 'O CONTRATANTE se compromete a:');
    addList([ 'Disponibilizar local seguro e protegido de intempéries para a montagem dos equipamentos;', 'Garantir ponto de energia elétrica estável e exclusivo para os equipamentos do DJ;', 'Efetuar o pagamento do valor acordado na forma e prazos definidos na Cláusula 4ª.']);
    addClause('CLÁUSULA 4ª - DO VALOR E PAGAMENTO', `O valor total dos serviços é de ${document.getElementById('contract-total-value').textContent} (${document.getElementById('contract-total-value-extenso').textContent}), pago da seguinte forma: ${document.getElementById('contract-payment-1').textContent}% na assinatura, ${document.getElementById('contract-payment-2').textContent}% até 7 dias antes do evento, e ${document.getElementById('contract-payment-3').textContent}% no dia do evento.`);
    addClause('CLÁUSULA 5ª - DA RESCISÃO', `Em caso de cancelamento pelo CONTRATANTE, a multa será de 50% do valor total se cancelado com menos de 30 dias de antecedência. O não comparecimento injustificado do CONTRATADO implicará na devolução integral dos valores pagos, acrescido de multa de 50% sobre o valor do contrato.`);
    addClause('CLÁUSULA 6ª - DO FORO', `Fica eleito o foro da comarca de ${document.getElementById('contract-legal-place').textContent} para dirimir quaisquer litígios oriundos deste contrato.`);
    y += lineSpacing * 2;
    doc.text('E, por estarem justos e contratados, assinam o presente em duas vias de igual teor e forma.', margin, y);
    y += lineSpacing * 4;
    
    const signatureWidth = usableWidth / 2 - 20;
    doc.line(margin, y, margin + signatureWidth, y);
    doc.line(pageWidth - margin - signatureWidth, y, pageWidth - margin, y);
    y += lineSpacing;
    doc.text('CONTRATANTE', margin, y);
    doc.text('CONTRATADO', pageWidth - margin, y, { align: 'right' });
    
    doc.save(`Contrato_DJ_${document.getElementById('contract-client-name').textContent.replace(/\s/g, '_')}.pdf`);
  }
  
  function downloadEventOrderAsPDF() {
    const orderData = {
        clientName: document.getElementById('order-client-name').textContent,
        clientDoc: document.getElementById('order-client-doc').textContent,
        clientPhone: document.getElementById('order-client-phone').textContent,
        clientEmail: document.getElementById('order-client-email').textContent,
        eventType: document.getElementById('order-event-type').textContent,
        eventDate: document.getElementById('order-event-date').textContent,
        eventTime: document.getElementById('order-event-time').textContent,
        eventLocation: document.getElementById('order-event-location').textContent,
        eventGuests: document.getElementById('order-event-guests').textContent,
        services: Array.from(document.querySelectorAll('#order-services-list tr')).map(row => Array.from(row.cells).map(cell => cell.textContent)),
        totalValue: document.getElementById('order-total-value').textContent,
        paymentTerms: document.getElementById('order-payment-terms').textContent,
        notes: document.getElementById('order-notes').textContent,
        orderNumber: document.getElementById('order-number').textContent,
    };
    generateOrderPdf(orderData);
  }

  function downloadExistingOrderAsPDF(orderId) {
    const order = eventOrders.find(o => o.id === orderId);
    if (!order) {
        alert("Pedido não encontrado!");
        return;
    }
    const client = clients.find(c => c.id === order.clientId) || {};
    const orderData = {
        clientName: client.name || 'N/A',
        clientDoc: client.document || 'N/A',
        clientPhone: client.phone || 'N/A',
        clientEmail: client.email || 'N/A',
        eventType: order.eventType,
        eventDate: formatDate(order.eventDate),
        eventTime: order.eventTime,
        eventLocation: order.eventLocation,
        eventGuests: order.eventGuests,
        services: order.services.map((s, i) => [i + 1, s.description, formatCurrency(s.value)]),
        totalValue: formatCurrency(order.totalValue),
        paymentTerms: order.paymentTerms,
        notes: order.notes,
        orderNumber: order.orderNumber,
    };
    generateOrderPdf(orderData);
  }

  function generateOrderPdf(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const primaryColor = '#6a11cb';

    let { startY } = addModernDocLayout(doc, `PEDIDO DE SERVIÇOS Nº ${data.orderNumber}`);
    const drawInfoSection = (title, info, initialY) => {
        let currentY = initialY;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(primaryColor);
        doc.text(title, 15, currentY);
        currentY += 7;

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor('#333333');
        info.forEach(item => {
            doc.setFont(undefined, 'bold');
            doc.text(`${item.label}:`, 20, currentY);
            doc.setFont(undefined, 'normal');
            const valueLines = doc.splitTextToSize(String(item.value), 130);
            doc.text(valueLines, 55, currentY);
            currentY += (valueLines.length * 5) + 1;
        });
        return currentY + 6;
    };

    const clientData = [
        { label: 'Cliente', value: data.clientName },
        { label: 'Documento', value: data.clientDoc },
        { label: 'Contato', value: `${data.clientPhone} | ${data.clientEmail}` },
    ];
    startY = drawInfoSection("INFORMAÇÕES DO CLIENTE", clientData, startY);
    const eventData = [
        { label: 'Evento', value: data.eventType },
        { label: 'Data/Hora', value: `${data.eventDate} - ${data.eventTime}` },
        { label: 'Local', value: data.eventLocation },
        { label: 'Convidados', value: data.eventGuests },
    ];
    startY = drawInfoSection("DETALHES DO EVENTO", eventData, startY);

    doc.autoTable({
        startY: startY,
        head: [['Item', 'Descrição', 'Valor']],
        body: data.services,
        foot: [['', 'TOTAL', data.totalValue]],
        theme: 'grid',
        headStyles: { fillColor: primaryColor, textColor: '#FFFFFF', fontStyle: 'bold' },
        footStyles: { fillColor: '#F5F5F5', textColor: '#000000', fontStyle: 'bold', halign: 'right'},
        margin: { left: 15, right: 15 },
    });
    startY = doc.lastAutoTable.finalY + 10;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(primaryColor);
    doc.text("CONDIÇÕES DE PAGAMENTO", 15, startY);
    startY += 6;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor('#333333');
    doc.text(doc.splitTextToSize(data.paymentTerms, doc.internal.pageSize.width - 30), 15, startY);
    startY = doc.autoTable.previous.finalY > startY ? doc.autoTable.previous.finalY + 15 : startY + 15;

    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(primaryColor);
    doc.text("OBSERVAÇÕES", 15, startY);
    startY += 6;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor('#333333');
    doc.text(doc.splitTextToSize(data.notes || 'Nenhuma.', doc.internal.pageSize.width - 30), 15, startY);

    doc.save(`Pedido_${data.orderNumber}_${data.clientName.replace(/\s/g, '_')}.pdf`);
  }

  // NOVO RECURSO: Função para baixar o Orçamento em PDF
  function downloadEventQuoteAsPDF(quoteId) {
    const quote = eventQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    const client = clients.find(c => c.id === quote.clientId) || {};
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const primaryColor = '#6a11cb';

    let { startY } = addModernDocLayout(doc, `ORÇAMENTO DE SERVIÇOS Nº ${quote.quoteNumber}`);

    const drawInfoSection = (title, info, initialY) => {
        let currentY = initialY;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(primaryColor);
        doc.text(title, 15, currentY);
        currentY += 7;

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor('#333333');
        info.forEach(item => {
            doc.setFont(undefined, 'bold');
            doc.text(`${item.label}:`, 20, currentY);
            doc.setFont(undefined, 'normal');
            const valueLines = doc.splitTextToSize(String(item.value), 130);
            doc.text(valueLines, 55, currentY);
            currentY += (valueLines.length * 5) + 1;
        });
        return currentY + 6;
    };

    const clientData = [
        { label: 'Cliente', value: client.name || 'N/A' },
        { label: 'Contato', value: `${client.phone || 'N/A'} | ${client.email || 'N/A'}` },
    ];
    startY = drawInfoSection("DADOS DO CLIENTE", clientData, startY);

    const eventData = [
        { label: 'Evento', value: quote.eventType },
        { label: 'Data/Hora', value: `${formatDate(quote.eventDate)} - ${quote.eventTime}` },
        { label: 'Local', value: quote.eventLocation },
    ];
    startY = drawInfoSection("DETALHES DO EVENTO", eventData, startY);

    const tableData = quote.services.map(s => [s.description, formatCurrency(s.value)]);
    const totalValue = quote.services.reduce((sum, s) => sum + s.value, 0);

    doc.autoTable({
      startY: startY,
      head: [['Descrição do Serviço', 'Valor']],
      body: tableData,
      foot: [['TOTAL', formatCurrency(totalValue)]],
      theme: 'grid',
      headStyles: { fillColor: primaryColor, textColor: '#FFFFFF', fontStyle: 'bold' },
      footStyles: { fillColor: '#F5F5F5', textColor: '#000000', fontStyle: 'bold', halign: 'right'},
      margin: { left: 15, right: 15 },
    });
    startY = doc.lastAutoTable.finalY + 10;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(primaryColor);
    doc.text("CONDIÇÕES GERAIS", 15, startY);
    startY += 6;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor('#333333');
    doc.text(doc.splitTextToSize(`Este orçamento é válido por ${quote.validity} dias a partir da data de emissão (${formatDate(quote.emissionDate)}). O valor está sujeito a alterações após este período. A contratação do serviço se dará mediante a assinatura de contrato e/ou pagamento de sinal.`, doc.internal.pageSize.width - 30), 15, startY);
    startY += doc.splitTextToSize(doc.text, doc.internal.pageSize.width - 30).length * 5 + 10;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text("Observações:", 15, startY);
    doc.setFont(undefined, 'normal');
    doc.text(doc.splitTextToSize(quote.notes || 'Nenhuma.', doc.internal.pageSize.width - 30), 45, startY);

    doc.save(`Orcamento_${quote.quoteNumber}_${client.name.replace(/\s/g, '_')}.pdf`);
  }

  function compressImage(base64Str, maxWidth = 800, maxHeight = 800) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = base64Str;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                }
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
        };
        img.onerror = (err) => {
            reject(err);
        };
    });
  }
  
  function formatCurrency(v) { 
    if(typeof v !== 'number') return 'R$ 0,00';
    return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); 
  }
  
  function formatDate(d) { 
    if (!d) return 'Não informado';
    try {
      const date = new Date(d);
      if (isNaN(date.getTime())) return d;
      const timezoneOffset = date.getTimezoneOffset() * 60000;
      return new Date(date.getTime() + timezoneOffset).toLocaleDateString('pt-BR');
    } catch {
      return d;
    }
  }
  
  function formatPercentageChange(current, previous, invert = false) {
    if (previous === 0) {
        if (current > 0) return `<span class="trend up"><i class="fas fa-arrow-up"></i> Novo</span>`;
        if (current < 0) return `<span class="trend down"><i class="fas fa-arrow-down"></i> Novo</span>`;
        return '';
    }
    const change = ((current - previous) / Math.abs(previous)) * 100;
    if(!isFinite(change) || change === 0) return '<span style="color: var(--gray); font-size: 0.75rem;"> s/ alteração</span>';
    const dir = change > 0 ? 'up' : 'down';
    let finalDir = invert ? (dir === 'up' ? 'down' : 'up') : dir;
    if(invert && change < 0) finalDir = 'up';
    if(invert && change > 0) finalDir = 'down';
    return `<span class="trend ${finalDir}"><i class="fas fa-arrow-${dir}"></i> ${change.toFixed(0)}%</span>`;
  }
  
  function numberToWords(num) {
    num = parseFloat(num);
    if(isNaN(num)) return '';

    function intToWords(n) {
        if (n === 0) return 'zero';
        const units = ['', 'um', 'dois', 'três', 'quatro', 'cinco', 'seis', 'sete', 'oito', 'nove'];
        const teens = ['dez', 'onze', 'doze', 'treze', 'catorze', 'quinze', 'dezesseis', 'dezessete', 'dezoito', 'dezenove'];
        const tens = ['', '', 'vinte', 'trinta', 'quarenta', 'cinquenta', 'sessenta', 'setenta', 'oitenta', 'noventa'];
        const hundreds = ['', 'cento', 'duzentos', 'trezentos', 'quatrocentos', 'quinhentos', 'seiscentos', 'setecentos', 'oitocentos', 'novecentos'];

        let words = '';
        if (n >= 1000) {
            const thousands = Math.floor(n / 1000);
            words += (thousands === 1 ? 'mil' : intToWords(thousands) + ' mil');
            n %= 1000;
            if (n > 0) words += (n < 100 && n % 100 !== 0) ? ' e ' : ' ';
        }
        if (n >= 100) {
            words += (n === 100 ? 'cem' : hundreds[Math.floor(n / 100)]);
            n %= 100;
            if (n > 0) words += ' e ';
        }
        if (n >= 20) {
            words += tens[Math.floor(n / 10)];
            n %= 10;
            if (n > 0) words += ' e ';
        }
        if (n > 0) {
            words += n < 10 ? units[n] : teens[n - 10];
        }
        return words.trim();
    }

    const intPart = Math.floor(num);
    const decPart = Math.round((num - intPart) * 100);
    let result = intToWords(intPart) + (intPart === 1 ? ' real' : ' reais');
    if (decPart > 0) {
        result += ' e ' + intToWords(decPart) + (decPart === 1 ? ' centavo' : ' centavos');
    }
    return result;
  }
  
  function updateAllCharts() {
    createOrUpdateChart('overview-chart', 'bar', getOverviewData(), { responsive: true, plugins: { title: { display: true, text: 'Receitas vs Despesas (Últimos 6 Meses)'}, legend: { position: 'top' }}, scales: { y: { beginAtZero: true }}});
    createOrUpdateChart('monthly-report-chart', 'doughnut', getMonthlyData('despesa'), { responsive: true, plugins: { title: { display: true, text: 'Despesas por Categoria (Mês Atual)'}, legend: { position: 'right' }}});
    createOrUpdateChart('category-report-chart', 'pie', getMonthlyData('receita'), { responsive: true, plugins: { title: { display: true, text: 'Receitas por Categoria (Mês Atual)'}, legend: { position: 'right' }}});
    createOrUpdateChart('annual-report-chart', 'line', getAnnualNetData(), { responsive: true, plugins: { title: { display: true, text: 'Balanço Mensal (Último Ano)'}, legend: { display: false }}, scales: { y: { beginAtZero: false }}});
    updateEventTypeReport();
  }

  function updateEventTypeReport() {
    const filterSelect = document.getElementById('event-type-report-filter');
    const resultsTbody = document.getElementById('event-type-report-results');

    if (!filterSelect || !resultsTbody) return;

    const currentFilterValue = filterSelect.value;
    
    const eventTypes = [...new Set(eventOrders.map(o => o.eventType))];
    filterSelect.innerHTML = '<option value="">-- Todos --</option>';
    eventTypes.sort().forEach(type => {
        filterSelect.add(new Option(type, type));
    });

    filterSelect.value = currentFilterValue;

    const renderReport = () => {
        const selectedType = filterSelect.value;
        const filteredOrders = selectedType 
            ? eventOrders.filter(o => o.eventType === selectedType)
            : eventOrders;

        resultsTbody.innerHTML = '';

        if (filteredOrders.length === 0) {
            resultsTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">Nenhum evento encontrado.</td></tr>';
            return;
        }

        filteredOrders
          .sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate))
          .forEach(order => {
            const client = clients.find(c => c.id === order.clientId) || { name: 'Cliente não encontrado' };
            const row = `
                <tr>
                    <td>${client.name}</td>
                    <td>${formatDate(order.eventDate)}</td>
                    <td class="positive">${formatCurrency(order.totalValue)}</td>
                </tr>
            `;
            resultsTbody.innerHTML += row;
        });
    };

    if (!filterSelect.dataset.listenerAttached) {
        filterSelect.addEventListener('change', renderReport);
        filterSelect.dataset.listenerAttached = 'true';
    }

    renderReport();
  }

  function createOrUpdateChart(id, type, data, opts) {
      const ctx = document.getElementById(id)?.getContext('2d');
      if(!ctx) return;
      if (chartInstances[id]) chartInstances[id].destroy();
      chartInstances[id] = new Chart(ctx, { type, data, options: opts });
  }

  function getOverviewData() {
    const labels = [];
    const receitas = [];
    const despesas = [];
    for (let i = 5; i >= 0; i--) {
      const date = new Date();
      date.setMonth(date.getMonth() - i);
      labels.push(date.toLocaleString('pt-BR', { month: 'short' }));
      const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
      const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      const monthTxs = transactions.filter(t => t.status === 'confirmada' && new Date(t.date + 'T00:00:00') >= monthStart && new Date(t.date + 'T00:00:00') <= monthEnd);
      receitas.push(monthTxs.filter(t => t.type === 'receita').reduce((s, t) => s + t.amount, 0));
      despesas.push(monthTxs.filter(t => t.type === 'despesa').reduce((s, t) => s + t.amount, 0));
    }
    return { labels, datasets: [{ label: 'Receitas', data: receitas, backgroundColor: 'rgba(46, 185, 84, 0.7)'}, { label: 'Despesas', data: despesas, backgroundColor: 'rgba(255, 65, 108, 0.7)'}]};
  }
  
  function getMonthlyData(type) {
    const today = new Date();
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const txs = transactions.filter(t => t.status === 'confirmada' && t.type === type && new Date(t.date + 'T00:00:00') >= monthStart);
    const data = txs.reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
    const colors = type === 'receita' ? ['#1db954', '#27ae60', '#2ecc71'] : ['#ff416c', '#e74c3c', '#c0392b'];
    return { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colors }]};
  }
  
  function getAnnualNetData() {
    const labels = [];
    const balanco = [];
    for (let i = 11; i >= 0; i--) {
      const date = new Date();
      date.setMonth(date.getMonth() - i);
      labels.push(date.toLocaleString('pt-BR', { month: 'short' }));
      const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
      const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      const monthTxs = transactions.filter(t => t.status === 'confirmada' && new Date(t.date + 'T00:00:00') >= monthStart && new Date(t.date + 'T00:00:00') <= monthEnd);
      const receitas = monthTxs.filter(t => t.type === 'receita').reduce((s, t) => s + t.amount, 0);
      const despesas = monthTxs.filter(t => t.type === 'despesa').reduce((s, t) => s + t.amount, 0);
      balanco.push(receitas - despesas);
    }
    return { labels, datasets: [{ label: 'Balanço Mensal', data: balanco, borderColor: 'var(--primary)', fill: false, tension: 0.1 }]};
  }
  
  function exportBackup() {
    const data = { accounts, transactions, goals, creditcards, userInfo, categories, receipts, clients, commitments, eventOrders, eventQuotes, userLogo };
    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `financepro_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    document.getElementById('backup-message').textContent = 'Backup exportado!';
  }

  function importBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      if (confirm('Atenção: Isso substituirá todos os dados atuais. Deseja continuar?')) {
        try {
          const data = JSON.parse(e.target.result);
          accounts = data.accounts || [];
          transactions = data.transactions || [];
          goals = data.goals || [];
          creditcards = data.creditcards || [];
          userInfo = data.userInfo || {};
          categories = data.categories || [];
          receipts = data.receipts || [];
          clients = data.clients || [];
          commitments = data.commitments || [];
          eventOrders = data.eventOrders || []; 
          eventQuotes = data.eventQuotes || []; // NOVO
          userLogo = data.userLogo || null;
          saveData();
          updateUI();
          alert('Backup restaurado com sucesso!');
          showTab('dashboard');
        } catch (err) {
          alert('Erro ao importar o backup.');
        }
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  }

  function renderCalendar(date) {
    const container = document.getElementById('calendar-container');
    if (!container) return;
    
    const today = new Date();
    today.setHours(0,0,0,0);
    const month = date.getMonth();
    const year = date.getFullYear();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay();
    const commitmentsByDate = commitments.reduce((acc, comm) => {
        const dateKey = comm.date.split('T')[0];
        if (!acc[dateKey]) acc[dateKey] = [];
        acc[dateKey].push(comm);
        return acc;
    }, {});
    let html = `
        <div class="calendar-header">
            <button class="calendar-nav-btn" id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
            <h3>${date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</h3>
            <button class="calendar-nav-btn" id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="calendar-weekdays">
            <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
        </div>
        <div class="calendar-grid">
    `;
    for (let i = 0; i < startDayOfWeek; i++) {
        html += `<div class="calendar-day empty-day"></div>`;
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const dateString = currentDate.toISOString().split('T')[0];
        
        let classes = 'calendar-day';
        if (currentDate.getTime() === today.getTime()) {
            classes += ' current-day';
        }
        if (commitmentsByDate[dateString]) {
            classes += ' has-commitment';
        }

        html += `<div class="${classes}" data-date="${dateString}">${day}</div>`;
    }

    html += `</div>`;
    container.innerHTML = html;

    document.getElementById('prev-month-btn').addEventListener('click', () => {
        calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
        renderCalendar(calendarCurrentDate);
        updateCommitmentsList();
    });
    document.getElementById('next-month-btn').addEventListener('click', () => {
        calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
        renderCalendar(calendarCurrentDate);
        updateCommitmentsList();
    });
    document.querySelector('.calendar-grid').addEventListener('click', (e) => {
        const dayEl = e.target.closest('.calendar-day:not(.empty-day)');
        if (dayEl) {
           showCommitmentsForDay(dayEl.dataset.date);
        }
    });
    updateCommitmentsList();
  }

  function showCommitmentsForDay(dateString) {
      const dayCommitments = commitments.filter(c => c.date.startsWith(dateString));
      const modal = document.getElementById('calendar-commitments-modal');
      const title = modal.querySelector('#calendar-modal-title');
      const body = modal.querySelector('#calendar-modal-body');
      title.textContent = `Agenda de ${formatDate(dateString)}`;
      let bodyHtml = '';
      if (dayCommitments.length > 0) {
        dayCommitments
            .sort((a,b) => new Date(a.date) - new Date(b.date))
            .forEach(c => {
                const time = new Date(c.date).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                bodyHtml += `
                    <div class="commitment-item ${c.status}" data-action="edit-commitment-from-calendar" data-id="${c.id}" style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <strong>${time} - ${c.title}</strong>
                                <p style="margin: 5px 0; font-size: 0.9em; color: var(--text-color);">${c.description || 'Sem descrição'}</p>
                                ${c.linkedOrderId ? `<button class="btn btn-xs" data-action="edit-order-from-calendar" data-id="${c.linkedOrderId}" style="margin-top:10px;" onclick="event.stopPropagation()"><i class="fas fa-eye"></i> Ver/Editar Pedido</button>` : ''}
                            </div>
                            <div class="form-group" style="margin-bottom: 0; min-width: 120px;">
                               <select class="commitment-status-select" data-id="${c.id}" style="padding: 5px 8px; font-size: 0.85rem;" onclick="event.stopPropagation()">
                                    <option value="agendado" ${c.status === 'agendado' ? 'selected' : ''}>Agendado</option>
                                    <option value="confirmado" ${c.status === 'confirmado' ? 'selected' : ''}>Confirmado</option>
                                    <option value="realizado" ${c.status === 'realizado' ? 'selected' : ''}>Realizado</option>
                                    <option value="cancelado" ${c.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                               </select>
                            </div>
                        </div>
                    </div>
               `;
             });
      } else {
        bodyHtml = '<p style="text-align:center; padding: 20px 0;">Nenhum compromisso para este dia.</p>';
      }

      bodyHtml += `
        <div class="btn-container" style="margin-top: 20px; border-top: 1px solid var(--gray-light); padding-top: 20px;">
          <button class="btn" id="calendar-add-commitment-btn"><i class="fas fa-plus"></i> Novo Compromisso</button>
        </div>`;

      body.innerHTML = bodyHtml;

      document.getElementById('calendar-add-commitment-btn').onclick = () => {
        modal.classList.remove('active');
        openCommitmentModal('new', null, dateString);
      };
      
      modal.classList.add('active');
  }

  function updateAnaliseDashboard() {
    const confirmedTxs = transactions.filter(t => t.status === 'confirmada');
    const today = new Date();
    
    const thisYearStart = new Date(today.getFullYear(), 0, 1);
    const ytdTxs = confirmedTxs.filter(t => new Date(t.date + 'T00:00:00') >= thisYearStart);
    const ytdRevenue = ytdTxs.filter(t => t.type === 'receita').reduce((sum, t) => sum + t.amount, 0);
    const ytdExpenses = ytdTxs.filter(t => t.type === 'despesa').reduce((sum, t) => sum + t.amount, 0);
    const ytdProfit = ytdRevenue - ytdExpenses;
    const profitMargin = ytdRevenue > 0 ? (ytdProfit / ytdRevenue) * 100 : 0;
    const paidReceipts = receipts.filter(r => r.status === 'pago');
    const totalReceiptValue = paidReceipts.reduce((sum, r) => sum + r.amount, 0);
    const avgTicket = paidReceipts.length > 0 ? totalReceiptValue / paidReceipts.length : 0;

    document.getElementById('kpi-ytd-revenue').textContent = formatCurrency(ytdRevenue);
    document.getElementById('kpi-ytd-profit').textContent = formatCurrency(ytdProfit);
    document.getElementById('kpi-profit-margin').textContent = `${profitMargin.toFixed(1)}%`;
    document.getElementById('kpi-avg-ticket').textContent = formatCurrency(avgTicket);

    const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
    const thisMonthTxs = confirmedTxs.filter(t => new Date(t.date + 'T00:00:00') >= thisMonthStart);
    const lastMonthTxs = confirmedTxs.filter(t => {
        const txDate = new Date(t.date + 'T00:00:00');
        return txDate >= lastMonthStart && txDate <= lastMonthEnd;
    });
    const revenueThisMonth = thisMonthTxs.filter(t => t.type === 'receita').reduce((sum, t) => sum + t.amount, 0);
    const expenseThisMonth = thisMonthTxs.filter(t => t.type === 'despesa').reduce((sum, t) => sum + t.amount, 0);
    const revenueLastMonth = lastMonthTxs.filter(t => t.type === 'receita').reduce((sum, t) => sum + t.amount, 0);
    const expenseLastMonth = lastMonthTxs.filter(t => t.type === 'despesa').reduce((sum, t) => sum + t.amount, 0);

    document.getElementById('comp-month-revenue').textContent = formatCurrency(revenueThisMonth);
    document.getElementById('comp-month-revenue-trend').innerHTML = formatPercentageChange(revenueThisMonth, revenueLastMonth);
    document.getElementById('comp-month-expense').textContent = formatCurrency(expenseThisMonth);
    document.getElementById('comp-month-expense-trend').innerHTML = formatPercentageChange(expenseThisMonth, expenseLastMonth, true);
    const lastYearStart = new Date(today.getFullYear() - 1, 0, 1);
    const lastYearEnd = new Date(today.getFullYear() - 1, 11, 31);
    const lastYearTxs = confirmedTxs.filter(t => {
        const txDate = new Date(t.date + 'T00:00:00');
        return txDate >= lastYearStart && txDate <= lastYearEnd;
    });
    const revenueLastYear = lastYearTxs.filter(t => t.type === 'receita').reduce((sum, t) => sum + t.amount, 0);
    document.getElementById('comp-year-revenue').textContent = formatCurrency(ytdRevenue);
    document.getElementById('comp-year-revenue-trend').innerHTML = formatPercentageChange(ytdRevenue, revenueLastYear);
    
    const clientRevenue = paidReceipts.reduce((acc, r) => {
        acc[r.clientId] = (acc[r.clientId] || 0) + r.amount;
        return acc;
    }, {});
    const sortedClients = Object.entries(clientRevenue).sort(([,a],[,b]) => b - a).slice(0, 5);
    const topClientsList = document.getElementById('top-clients-list');
    topClientsList.innerHTML = '';
    if (sortedClients.length > 0) {
        sortedClients.forEach(([clientId, amount]) => {
            const client = clients.find(c => c.id === parseFloat(clientId));
            topClientsList.innerHTML += `<li><span class="name">${client ? client.name : 'Cliente Removido'}</span> <span class="amount">${formatCurrency(amount)}</span></li>`;
        });
    } else {
        topClientsList.innerHTML = '<li>Nenhum recibo pago encontrado.</li>';
    }
    
    const categoryRevenue = ytdTxs.filter(t => t.type === 'receita').reduce((acc, t) => {
        acc[t.category] = (acc[t.category] || 0) + t.amount;
        return acc;
    }, {});
    const sortedCategories = Object.entries(categoryRevenue).sort(([,a],[,b]) => b - a).slice(0, 5);
    const topCategoriesList = document.getElementById('top-revenue-categories-list');
    topCategoriesList.innerHTML = '';
    if(sortedCategories.length > 0) {
        sortedCategories.forEach(([category, amount]) => {
            topCategoriesList.innerHTML += `<li><span class="name">${category}</span> <span class="amount">${formatCurrency(amount)}</span></li>`;
        });
    } else {
        topCategoriesList.innerHTML = '<li>Nenhuma receita encontrada.</li>';
    }

    createOrUpdateChart('yoy-revenue-chart', 'bar', getYearOverYearRevenueData(), { responsive: true, plugins: { title: { display: true, text: 'Receita Mensal (Ano vs. Ano Anterior)' }, legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } });
    createOrUpdateChart('profit-margin-trend-chart', 'line', getProfitMarginTrendData(), { responsive: true, plugins: { title: { display: true, text: 'Tendência da Margem de Lucro (%)' }, legend: { display: false } }, scales: { y: { beginAtZero: false, ticks: { callback: (value) => `${value}%` } } } });
  }

  function getYearOverYearRevenueData() {
    const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const thisYearData = Array(12).fill(0);
    const lastYearData = Array(12).fill(0);
    
    const confirmedTxs = transactions.filter(t => t.status === 'confirmada' && t.type === 'receita');
    const thisYear = new Date().getFullYear();
    
    confirmedTxs.forEach(t => {
        const date = new Date(t.date + 'T00:00:00');
        const year = date.getFullYear();
        const month = date.getMonth();
        if (year === thisYear) {
            thisYearData[month] += t.amount;
        } else if (year === thisYear - 1) {
            lastYearData[month] += t.amount;
        }
    });
    return {
        labels,
        datasets: [
            { label: `Ano Anterior (${thisYear - 1})`, data: lastYearData, backgroundColor: 'rgba(149, 165, 166, 0.5)' },
            { label: `Ano Atual (${thisYear})`, data: thisYearData, backgroundColor: 'rgba(106, 17, 203, 0.7)' }
        ]
    };
  }

  function getProfitMarginTrendData() {
    const labels = [];
    const margins = [];
    const confirmedTxs = transactions.filter(t => t.status === 'confirmada');

    for (let i = 11; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        labels.push(date.toLocaleString('pt-BR', { month: 'short' }));

        const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
        const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

        const monthTxs = confirmedTxs.filter(t => {
            const txDate = new Date(t.date + 'T00:00:00');
            return txDate >= monthStart && txDate <= monthEnd;
        });
        const revenue = monthTxs.filter(t => t.type === 'receita').reduce((sum, t) => sum + t.amount, 0);
        const expense = monthTxs.filter(t => t.type === 'despesa').reduce((sum, t) => sum + t.amount, 0);
        const margin = revenue > 0 ? ((revenue - expense) / revenue) * 100 : 0;
        margins.push(margin.toFixed(1));
    }

    return {
        labels,
        datasets: [{
            label: 'Margem de Lucro',
            data: margins,
            borderColor: 'var(--success)',
            backgroundColor: 'rgba(29, 185, 84, 0.1)',
            fill: true,
            tension: 0.2
        }]
    };
  }

  init();
});
</script>
</body>
</html>
